<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="运维自动化之Ansible本章内容 运维自动化发展历程及技术应用 Ansible命令使用 Ansible常用模块详解 YAML语法简介 Ansible playbook基础 Playbook变量、tags、handlers使用 Playbook模板templates Playbook条件判断 when Playbook字典 with_items Ansible Roles">
<meta property="og:type" content="article">
<meta property="og:title" content="运维自动化之Ansible">
<meta property="og:url" content="http://yoursite.com/2021/09/22/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BAnsible/index.html">
<meta property="og:site_name" content="陈鱼头的博客">
<meta property="og:description" content="运维自动化之Ansible本章内容 运维自动化发展历程及技术应用 Ansible命令使用 Ansible常用模块详解 YAML语法简介 Ansible playbook基础 Playbook变量、tags、handlers使用 Playbook模板templates Playbook条件判断 when Playbook字典 with_items Ansible Roles">
<meta property="og:image" content="https://note.youdao.com/yws/res/100098/FD38F2B4BE0B49578DCC4CB58E218543">
<meta property="og:image" content="https://note.youdao.com/yws/res/100106/8B5EADE22C804A65A1D9027206BD15F4">
<meta property="og:image" content="https://note.youdao.com/yws/res/100097/A6150393F3CF41DEAFD7A7002C2F952E">
<meta property="og:image" content="https://note.youdao.com/yws/res/100101/63539E099AD1483D87CD28CBD473463B">
<meta property="og:image" content="https://note.youdao.com/yws/res/100102/31BB6620C07C4E8DAEC14CB20CF8C573">
<meta property="og:image" content="https://note.youdao.com/yws/res/100105/B2206BA3F50D46ACBCC941F778A2C845">
<meta property="article:published_time" content="2021-09-22T02:10:51.000Z">
<meta property="article:modified_time" content="2022-04-13T16:46:13.801Z">
<meta property="article:author" content="运维笔记 QQ:1714594511">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://note.youdao.com/yws/res/100098/FD38F2B4BE0B49578DCC4CB58E218543">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":60,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/09/22/运维自动化之Ansible/"/>





  <title>运维自动化之Ansible | 陈鱼头的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">陈鱼头的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>
	

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/22/%E8%BF%90%E7%BB%B4%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B9%8BAnsible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="运维笔记 QQ:1714594511">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="陈鱼头的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">运维自动化之Ansible</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-09-22T10:10:51+08:00">
                2021-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ansible/" itemprop="url" rel="index">
                    <span itemprop="name">ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<h1 id="运维自动化之Ansible"><a href="#运维自动化之Ansible" class="headerlink" title="运维自动化之Ansible"></a>运维自动化之Ansible</h1><h3 id="本章内容"><a href="#本章内容" class="headerlink" title="本章内容"></a>本章内容</h3><ul>
<li>运维自动化发展历程及技术应用</li>
<li>Ansible命令使用</li>
<li>Ansible常用模块详解</li>
<li>YAML语法简介</li>
<li>Ansible playbook基础</li>
<li>Playbook变量、tags、handlers使用</li>
<li>Playbook模板templates</li>
<li>Playbook条件判断 when</li>
<li>Playbook字典 with_items</li>
<li>Ansible Roles</li>
</ul>
<a id="more"></a>
<hr>
<h3 id="企业实际应用场景分析"><a href="#企业实际应用场景分析" class="headerlink" title="企业实际应用场景分析"></a>企业实际应用场景分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Dev开发环境</span><br><span class="line">    使用者：程序员</span><br><span class="line">    功能：程序员开发软件，测试BUG的环境</span><br><span class="line">    管理者：程序员</span><br><span class="line"></span><br><span class="line">测试环境    </span><br><span class="line">    使用者：QA测试工程师</span><br><span class="line">    功能：测试经过Dev环境测试通过的软件的功能</span><br><span class="line">    管理者：运维</span><br><span class="line"></span><br><span class="line">说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多</span><br><span class="line">1、测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试</span><br><span class="line">2、通常测试环境有多少套和产品线数量保持一样</span><br><span class="line"></span><br><span class="line">发布环境：代码发布机，有些公司为堡垒机（安全屏障）</span><br><span class="line">    使用者：运维</span><br><span class="line">    功能：发布代码至生产环境</span><br><span class="line">    管理者：运维（有经验）</span><br><span class="line">    发布机：往往需要有2台（主备）</span><br><span class="line"></span><br><span class="line">生产环境</span><br><span class="line">    使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全</span><br><span class="line">    开放给开发人员并其维护</span><br><span class="line">    功能：对用户提供公司产品的服务</span><br><span class="line"></span><br><span class="line">管理者：只能是运维</span><br><span class="line">    生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用</span><br><span class="line"></span><br><span class="line">灰度环境（生产环境的一部分）</span><br><span class="line">    使用者：运维</span><br><span class="line">    功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基</span><br><span class="line">    于主机或用户执行灰度发布</span><br><span class="line">    案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器</span><br><span class="line">    管理者：运维</span><br><span class="line">    灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，</span><br><span class="line">              待这部分用户使用没有重大问题的时候，再全量发布至所有服务器</span><br></pre></td></tr></table></figure>

<h3 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">文件传输</span><br><span class="line">应用部署</span><br><span class="line">配置管理</span><br><span class="line">任务流编排</span><br></pre></td></tr></table></figure>

<h3 id="常用自动化运维工具"><a href="#常用自动化运维工具" class="headerlink" title="常用自动化运维工具"></a>常用自动化运维工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Ansible：python，Agentless，中小型应用环境</span><br><span class="line">Saltstack：python，一般需部署agent，执行效率更高</span><br><span class="line">Puppet：ruby, 功能强大，配置复杂，重型,适合大型环境</span><br><span class="line">Fabric：python，agentless</span><br><span class="line">Chef：ruby，国内应用少</span><br><span class="line">Cfengine</span><br><span class="line">func</span><br></pre></td></tr></table></figure>


<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1&gt; 模块化：调用特定的模块，完成特定任务</span><br><span class="line">2&gt; Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</span><br><span class="line">3&gt; 支持自定义模块</span><br><span class="line">4&gt; 基于Python语言实现</span><br><span class="line">5&gt; 部署简单，基于python和SSH(默认已安装)，agentless</span><br><span class="line">6&gt; 安全，基于OpenSSH</span><br><span class="line">7&gt; 支持playbook编排任务</span><br><span class="line">8&gt; 幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</span><br><span class="line">9&gt; 无需代理不依赖PKI（无需ssl）</span><br><span class="line">10&gt; 可使用任何编程语言写模块</span><br><span class="line">11&gt; YAML格式，编排任务，支持丰富的数据结构</span><br><span class="line">12&gt; 较强大的多层解决方案</span><br></pre></td></tr></table></figure>
<h3 id="推公钥"><a href="#推公钥" class="headerlink" title="推公钥"></a>推公钥</h3><p> 系统 环境为centos，执行脚本前请在当前目录创建ip.txt文件，把需要推送的服务器的ip及密码填写好。<br> 1.在脚本当前目录，编辑ip.txt文本,填写相应信息<br>  #请填写需要推送的服务器ip和i密码<br>  #格式：ip 空格（不分空格次数，只要是空格就可以） 密码<br>  #例：192.168.23.111  passwd<br>  #例：192.168.23.112  passwd</p>
<p> 2.执行脚本推送公钥 curl -o ssh.sh <a href="http://xz.itcytblog.cn/ssh.sh&amp;&amp;" target="_blank" rel="noopener">http://xz.itcytblog.cn/ssh.sh&amp;&amp;</a> bash ssh.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#! /bash/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f ./ip.txt ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'不存在ip.txt文件,请配置好ip及密码'</span> </span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[ ! -f /root/.ssh/id_rsa.pub ] &amp;&amp; ssh-keygen -P <span class="string">''</span> -f /root/.ssh/id_rsa &amp;&gt;/dev/null</span><br><span class="line">[ -f /usr/bin/expect ]||yum -y install expect</span><br><span class="line"></span><br><span class="line">add=`cat ./ip.txt|wc -l`</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="variable">$add</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        ip=`sed -n  <span class="variable">$&#123;i&#125;</span>p ./ip.txt | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">        pass=`sed -n  <span class="variable">$&#123;i&#125;</span>p ./ip.txt | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">        ping -c1 <span class="variable">$ip</span> &amp;&gt;/dev/null</span><br><span class="line">        <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$ip</span> &gt;&gt; ./ip_up.txt</span><br><span class="line">        /usr/bin/expect &lt;&lt;-END</span><br><span class="line">        <span class="built_in">set</span> timeout 10</span><br><span class="line">        spawn ssh-copy-id root@<span class="variable">$ip</span></span><br><span class="line">        expect <span class="string">"yes/no"</span> &#123; send <span class="string">"yes\r"</span>;exp_continue &#125;</span><br><span class="line">        expect <span class="string">"password:"</span> &#123; send <span class="string">"<span class="variable">$pass</span>\r"</span> &#125;</span><br><span class="line">                expect eof</span><br><span class="line">        END</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$ip</span> &gt;&gt; ./ip_down.txt</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>=`cat ./ip_up.txt|wc -l`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq <span class="variable">$test</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        remote_ip=`sed -n <span class="variable">$&#123;i&#125;</span>p ./ip_up.txt`</span><br><span class="line">        ssh root@<span class="variable">$remote_ip</span> hostname</span><br><span class="line">        [ $? -eq 0 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"公钥推送成功"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>


<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rpm包安装: EPEL源</span><br><span class="line">    yum install ansible</span><br><span class="line"></span><br><span class="line">编译安装:</span><br><span class="line">    yum -y install python-jinja2 PyYAML python-paramiko python-babel</span><br><span class="line">    python-crypto</span><br><span class="line">    tar xf ansible-1.5.4.tar.gz</span><br><span class="line">    cd ansible-1.5.4</span><br><span class="line">    python setup.py build</span><br><span class="line">    python setup.py install</span><br><span class="line">    mkdir &#x2F;etc&#x2F;ansible</span><br><span class="line">    cp -r examples&#x2F;* &#x2F;etc&#x2F;ansible</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Git方式:</span><br><span class="line">    git clone git:&#x2F;&#x2F;github.com&#x2F;ansible&#x2F;ansible.git --recursive</span><br><span class="line">    cd .&#x2F;ansible</span><br><span class="line">    source .&#x2F;hacking&#x2F;env-setup</span><br><span class="line"></span><br><span class="line">pip安装： pip是安装Python包的管理器，类似yum</span><br><span class="line">    yum install python-pip python-devel</span><br><span class="line">    yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel</span><br><span class="line">    pip install --upgrade pip</span><br><span class="line">    pip install ansible --upgrade</span><br><span class="line"></span><br><span class="line">确认安装：</span><br><span class="line">    ansible --version</span><br></pre></td></tr></table></figure>

<h3 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">配置文件</span><br><span class="line">    &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg  主配置文件,配置ansible工作特性(一般无需修改)</span><br><span class="line">    &#x2F;etc&#x2F;ansible&#x2F;hosts        主机清单(将被管理的主机放到此文件)</span><br><span class="line">    &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;       存放角色的目录</span><br><span class="line"></span><br><span class="line">程序</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible          主程序，临时命令执行工具</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-doc      查看配置文档，模块功能查看工具</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-galaxy   下载&#x2F;上传优秀代码或Roles模块的官网平台</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-playbook 定制自动化任务，编排剧本工具</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-pull     远程执行命令的工具</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-vault    文件加密工具</span><br><span class="line">    &#x2F;usr&#x2F;bin&#x2F;ansible-console  基于Console界面与用户交互的执行工具</span><br></pre></td></tr></table></figure>

<h3 id="主机清单inventory"><a href="#主机清单inventory" class="headerlink" title="主机清单inventory"></a>主机清单inventory</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Inventory 主机清单</span><br><span class="line">1&gt; ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory file中将其分组命名 </span><br><span class="line">2&gt; 默认的inventory file为&#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">3&gt; inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成</span><br><span class="line"></span><br><span class="line">&#x2F;etc&#x2F;ansible&#x2F;hosts文件格式</span><br><span class="line">inventory文件遵循INI文件风格，中括号中的字符为组名。</span><br><span class="line">可以将同一个主机同时归并到多个不同的组中；</span><br><span class="line">此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明</span><br><span class="line">    ntp.magedu.com   不分组,直接加</span><br><span class="line">    </span><br><span class="line">    [webservers]     webservers组</span><br><span class="line">    www1.magedu.com:2222  可以指定端口</span><br><span class="line">    www2.magedu.com</span><br><span class="line">    </span><br><span class="line">    [dbservers]</span><br><span class="line">    db1.magedu.com</span><br><span class="line">    db2.magedu.com</span><br><span class="line">    db3.magedu.com</span><br><span class="line"></span><br><span class="line">如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机</span><br><span class="line">示例：</span><br><span class="line">    [websrvs]</span><br><span class="line">    www[1:100].example.com   ip: 1-100</span><br><span class="line">    </span><br><span class="line">    [dbsrvs]</span><br><span class="line">    db-[a:f].example.com     dba-dbff</span><br><span class="line"></span><br><span class="line">### 不配置密钥，可以直接配置密码</span><br><span class="line">    [test]</span><br><span class="line">    192.168.159.132 </span><br><span class="line"></span><br><span class="line">    [test:vars]</span><br><span class="line">    ansible_ssh_pass&#x3D;123456</span><br><span class="line"></span><br><span class="line">主机清单常用变量</span><br><span class="line">参数	用途	例子</span><br><span class="line">ansible_ssh_host	定义hosts ssh地址	ansible_ssh_host&#x3D;192.168.81.220</span><br><span class="line">ansible_ssh_port	定义hosts 端口号也可以在ip后面加:定义	ansible_ssh_prrot&#x3D;666</span><br><span class="line">ansibe_ssh_user	定义hosts ssh认证用户	ansible_ssh_user&#x3D;user</span><br><span class="line">ansible_ssh_pass	定义hosts ssh认证密码	ansible_ssh_pass&#x3D;redhat</span><br><span class="line">ansibe_sudo	定义hosts sudo用户	ansible_sudo&#x3D;www</span><br><span class="line">ansibe_sudo_pass	定义hosts sudo用户的认证密码	ansible_sudo_pass&#x3D;redhat</span><br><span class="line">ansibe_sudo_exe	定义sudo命令的路径	ansible_sudo_exe&#x3D;&#x2F;usr&#x2F;bin&#x2F;sudo</span><br><span class="line">ansible_coneection	定义hosts连接方式	ansible_connection&#x3D;local</span><br><span class="line">ansible_ssh_private_key_file	定义hosts私钥	ansible_ssh_private_key_file&#x3D;&#x2F;root&#x2F;key</span><br><span class="line">ansible_ssh_shell_tyep	定义hosts shell类型	ansible_ssh_shell_type&#x3D;bash</span><br><span class="line">ansible_python_interpreter	定义hosts任务执行python路径	ansible_python_interpreter&#x3D;&#x2F;usr&#x2F;bin&#x2F;python2.6</span><br><span class="line">ansbile_*—interpreter	定义hosts解析其他语言路径	ansible_*-interpreter&#x3D;&#x2F;usr&#x2F;bin&#x2F;ruby（前后都是下划线）</span><br></pre></td></tr></table></figure>

<h3 id="ansible-配置文件"><a href="#ansible-配置文件" class="headerlink" title="ansible 配置文件"></a>ansible 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Ansible 配置文件&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg （一般保持默认）</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</span><br><span class="line"></span><br><span class="line">[defaults]</span><br><span class="line">#inventory     &#x3D; &#x2F;etc&#x2F;ansible&#x2F;hosts      # 主机列表配置文件</span><br><span class="line">#library       &#x3D; &#x2F;usr&#x2F;share&#x2F;my_modules&#x2F;  # 库文件存放目录</span><br><span class="line">#remote_tmp    &#x3D; $HOME&#x2F;.ansible&#x2F;tmp      # 临时py命令文件存放在远程主机目录</span><br><span class="line">#local_tmp     &#x3D; $HOME&#x2F;.ansible&#x2F;tmp      # 本机的临时命令执行目录  </span><br><span class="line">#forks         &#x3D; 5                       # 默认并发数,同时可以执行5次</span><br><span class="line">#sudo_user     &#x3D; root                    # 默认sudo 用户</span><br><span class="line">#ask_sudo_pass &#x3D; True                    # 每次执行ansible命令是否询问ssh密码</span><br><span class="line">#ask_pass      &#x3D; True                    # 每次执行ansible命令是否询问ssh口令</span><br><span class="line">#remote_port   &#x3D; 22                      # 远程主机的端口号(默认22)</span><br><span class="line"></span><br><span class="line">建议优化项： </span><br><span class="line">host_key_checking &#x3D; False               # 检查对应服务器的host_key，建议取消注释</span><br><span class="line">log_path&#x3D;&#x2F;var&#x2F;log&#x2F;ansible.log           # 日志文件,建议取消注释</span><br><span class="line">module_name   &#x3D; command                 # 默认模块</span><br></pre></td></tr></table></figure>

<h3 id="ansible系列命令"><a href="#ansible系列命令" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Ansible系列命令</span><br><span class="line">    ansible ansible-doc ansible-playbook ansible-vault ansible-console</span><br><span class="line">    ansible-galaxy ansible-pull</span><br><span class="line"></span><br><span class="line">ansible-doc: 显示模块帮助</span><br><span class="line">    ansible-doc [options] [module...]</span><br><span class="line">        -a            显示所有模块的文档</span><br><span class="line">        -l, --list    列出可用模块</span><br><span class="line">        -s, --snippet 显示指定模块的playbook片段(简化版,便于查找语法)</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">    ansible-doc -l      列出所有模块</span><br><span class="line">    ansible-doc ping    查看指定模块帮助用法</span><br><span class="line">    ansible-doc -s ping 查看指定模块帮助用法</span><br></pre></td></tr></table></figure>

<h3 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ansible通过ssh实现配置管理、应用部署、任务执行等功能，</span><br><span class="line">建议配置ansible端能基于密钥认证的方式联系各被管理节点</span><br><span class="line"></span><br><span class="line">ansible &lt;host-pattern&gt; [-m module_name] [-a args]</span><br><span class="line">ansible +被管理的主机(ALL) +模块  +参数</span><br><span class="line">    --version              显示版本</span><br><span class="line">    -m module              指定模块，默认为command</span><br><span class="line">    -v                     详细过程 –vv -vvv更详细</span><br><span class="line">    --list-hosts           显示主机列表，可简写 --list</span><br><span class="line">    -k, --ask-pass         提示输入ssh连接密码,默认Key验证</span><br><span class="line">    -C, --check            检查，并不执行</span><br><span class="line">    -T, --timeout&#x3D;TIMEOUT  执行命令的超时时间,默认10s</span><br><span class="line">    -u, --user&#x3D;REMOTE_USER 执行远程执行的用户</span><br><span class="line">    -b, --become           代替旧版的sudo切换</span><br><span class="line">        --become-user&#x3D;USERNAME 指定sudo的runas用户,默认为root</span><br><span class="line">    -K, --ask-become-pass  提示输入sudo时的口令</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ansible all --list  列出所有主机</span><br><span class="line">ping模块: 探测网络中被管理主机是否能够正常使用  走ssh协议</span><br><span class="line">          如果对方主机网络正常,返回pong</span><br><span class="line">ansible-doc -s ping   查看ping模块的语法 </span><br><span class="line"></span><br><span class="line">检测所有主机的网络状态</span><br><span class="line">1&gt;  默认情况下连接被管理的主机是ssh基于key验证,如果没有配置key,权限将会被拒绝</span><br><span class="line">    因此需要指定以谁的身份连接,输入用户密码,必须保证被管理主机用户密码一致</span><br><span class="line">    ansible all -m ping -k</span><br><span class="line"></span><br><span class="line">2&gt; 或者实现基于key验证 将公钥ssh-copy-id到被管理的主机上 , 实现免密登录</span><br><span class="line">   ansible all -m ping</span><br></pre></td></tr></table></figure>

<h3 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ansible的Host-pattern</span><br><span class="line">匹配主机的列表</span><br><span class="line">    All ：表示所有Inventory中的所有主机</span><br><span class="line">        ansible all –m ping</span><br><span class="line">    * :通配符</span><br><span class="line">        ansible &quot;*&quot; -m ping  (*表示所有主机)</span><br><span class="line">        ansible 192.168.1.* -m ping</span><br><span class="line">        ansible &quot;*srvs&quot; -m ping</span><br><span class="line">    或关系 &quot;:&quot;</span><br><span class="line">        ansible &quot;websrvs:appsrvs&quot; -m ping</span><br><span class="line">        ansible “192.168.1.10:192.168.1.20” -m ping</span><br><span class="line">    逻辑与 &quot;:&amp;&quot;</span><br><span class="line">        ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</span><br><span class="line">        在websrvs组并且在dbsrvs组中的主机</span><br><span class="line">    逻辑非 &quot;:!&quot;</span><br><span class="line">        ansible &#39;websrvs:!dbsrvs&#39; –m ping</span><br><span class="line">        在websrvs组，但不在dbsrvs组中的主机</span><br><span class="line">        注意：此处为单引号</span><br><span class="line">    综合逻辑</span><br><span class="line">        ansible &#39;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#39; –m ping</span><br><span class="line">    正则表达式</span><br><span class="line">        ansible &quot;websrvs:&amp;dbsrvs&quot; –m ping</span><br><span class="line">        ansible &quot;~(web|db).*\.magedu\.com&quot; –m ping</span><br></pre></td></tr></table></figure>

<h3 id="ansible命令执行过程"><a href="#ansible命令执行过程" class="headerlink" title="ansible命令执行过程"></a>ansible命令执行过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ansible命令执行过程</span><br><span class="line">    1. 加载自己的配置文件 默认&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</span><br><span class="line">    2. 加载自己对应的模块文件，如command</span><br><span class="line">    3. 通过ansible将模块或命令生成对应的临时py文件，</span><br><span class="line">       并将该文件传输至远程服务器的对应执行用户$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-数字&#x2F;XXX.PY文件</span><br><span class="line">    4. 给文件+x执行</span><br><span class="line">    5. 执行并返回结果</span><br><span class="line">    6. 删除临时py文件，sleep 0退出</span><br><span class="line"></span><br><span class="line">执行状态：</span><br><span class="line">    绿色：执行成功并且不需要做改变的操作</span><br><span class="line">    黄色：执行成功并且对目标主机做变更</span><br><span class="line">    红色：执行失败</span><br></pre></td></tr></table></figure>

<h3 id="ansible使用示例"><a href="#ansible使用示例" class="headerlink" title="ansible使用示例"></a>ansible使用示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">示例</span><br><span class="line">    以wang用户执行ping存活检测</span><br><span class="line">        ansible all -m ping -u wang -k</span><br><span class="line">    以wang sudo至root执行ping存活检测</span><br><span class="line">        ansible all -m ping -u wang -k -b</span><br><span class="line">    以wang sudo至mage用户执行ping存活检测</span><br><span class="line">        ansible all -m ping -u wang -k -b --become-user&#x3D;mage</span><br><span class="line">    以wang sudo至root用户执行ls</span><br><span class="line">        ansible all -m command -u wang -a &#39;ls &#x2F;root&#39; -b --become-user&#x3D;root -k -K</span><br><span class="line"></span><br><span class="line">ansible ping模块测试连接</span><br><span class="line">    ansible 192.168.38.126,192.168.38.127 -m ping -k</span><br></pre></td></tr></table></figure>

<h3 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">模块文档：https:&#x2F;&#x2F;docs.ansible.com&#x2F;ansible&#x2F;latest&#x2F;modules&#x2F;modules_by_category.html</span><br><span class="line"></span><br><span class="line">Command：在远程主机执行命令，默认模块，可忽略-m选项</span><br><span class="line">    &gt; ansible srvs -m command -a &#39;service vsftpd start&#39;</span><br><span class="line">    &gt; ansible srvs -m command -a &#39;echo adong |passwd --stdin 123456&#39;</span><br><span class="line">此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等,用shell模块实现</span><br><span class="line"></span><br><span class="line">    chdir:   进入到被管理主机目录</span><br><span class="line">    creates: 如果有一个目录是存在的,步骤将不会运行Command命令</span><br><span class="line">    ansible websrvs -a &#39;chdir&#x3D;&#x2F;data&#x2F; ls&#39;</span><br><span class="line"></span><br><span class="line">Shell：和command相似，用shell执行命令</span><br><span class="line">    &gt; ansible all -m shell  -a &#39;getenforce&#39;  查看SELINUX状态</span><br><span class="line">    &gt;  ansible all -m shell  -a &quot;sed -i &#39;s&#x2F;SELINUX&#x3D;.*&#x2F;SELINUX&#x3D;disabled&#39; &#x2F;etc&#x2F;selinux&#x2F;config&quot;</span><br><span class="line">    &gt; ansible srv -m shell -a &#39;echo magedu |passwd –stdin wang&#39;</span><br><span class="line">      </span><br><span class="line">    调用bash执行命令 类似 cat &#x2F;tmp&#x2F;stanley.md | awk -F&#39;|&#39; &#39;&#123;print $1,$2&#125;&#39; &amp;&gt; &#x2F;tmp&#x2F;example.txt     </span><br><span class="line">    这些复杂命令，即使使用shell也可能会失败，</span><br><span class="line">    解决办法：写到脚本时，copy到远程执行，再把需要的结果拉回执行命令的机器</span><br><span class="line"></span><br><span class="line">    修改配置文件,使shell作为默认模块    </span><br><span class="line">        vim &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</span><br><span class="line">        module_name &#x3D; shell</span><br><span class="line"></span><br><span class="line">Script：在远程主机上运行ansible服务器上的脚本</span><br><span class="line">    &gt; -a &quot;&#x2F;PATH&#x2F;TO&#x2F;SCRIPT_FILE&quot;</span><br><span class="line">    &gt; ansible websrvs -m script -a &#x2F;data&#x2F;test.sh</span><br><span class="line"></span><br><span class="line">Copy：从主控端复制文件到远程主机</span><br><span class="line">      src : 源文件  指定拷贝文件的本地路径  (如果有&#x2F; 则拷贝目录内容,比拷贝目录本身)</span><br><span class="line">      dest: 指定目标路径</span><br><span class="line">      mode: 设置权限</span><br><span class="line">      backup: 备份源文件</span><br><span class="line">      content: 代替src  指定本机文件内容,生成目标主机文件</span><br><span class="line">      </span><br><span class="line">      &gt; ansible websrvs -m copy -a &quot;src&#x3D;&#x2F;root&#x2F;test1.sh dest&#x3D;&#x2F;tmp&#x2F;test2.showner&#x3D;wang mode&#x3D;600 backup&#x3D;yes&quot;</span><br><span class="line">        如果目标存在，默认覆盖，此处指定先备份</span><br><span class="line">      &gt; ansible websrvs -m copy -a &quot;content&#x3D;&#39;test content\nxxx&#39; dest&#x3D;&#x2F;tmp&#x2F;test.txt&quot;</span><br><span class="line">        指定内容，直接生成目标文件</span><br><span class="line"></span><br><span class="line">Fetch：从远程主机提取文件至主控端，copy相反，目前不支持目录,可以先打包,再提取文件</span><br><span class="line">     &gt; ansible websrvs -m fetch -a &#39;src&#x3D;&#x2F;root&#x2F;test.sh dest&#x3D;&#x2F;data&#x2F;scripts&#39;</span><br><span class="line">     会生成每个被管理主机不同编号的目录,不会发生文件名冲突</span><br><span class="line">     </span><br><span class="line">     &gt; ansible all -m shell -a &#39;tar jxvf test.tar.gz &#x2F;root&#x2F;test.sh&#39;</span><br><span class="line">     &gt; ansible all -m fetch -a &#39;src&#x3D;&#x2F;root&#x2F;test.tar.gz dest&#x3D;&#x2F;data&#x2F;&#39;</span><br><span class="line"></span><br><span class="line">File：设置文件属性</span><br><span class="line">    path: 要管理的文件路径 (强制添加)</span><br><span class="line">    recurse: 递归,文件夹要用递归</span><br><span class="line">    src:  创建硬链接,软链接时,指定源目标,配合&#39;state&#x3D;link&#39; &#39;state&#x3D;hard&#39; 设置软链接,硬链接</span><br><span class="line">    state: 状态</span><br><span class="line">          absent 缺席,删除</span><br><span class="line">          </span><br><span class="line">    &gt; ansible websrvs -m file -a &#39;path&#x3D;&#x2F;app&#x2F;test.txt state&#x3D;touch&#39;       创建文件</span><br><span class="line">    &gt; ansible websrvs -m file -a &quot;path&#x3D;&#x2F;data&#x2F;testdir state&#x3D;directory&quot;   创建目录    </span><br><span class="line">    &gt; ansible websrvs -m file -a &quot;path&#x3D;&#x2F;root&#x2F;test.sh owner&#x3D;wang mode&#x3D;755&quot;  设置权限755</span><br><span class="line">    &gt; ansible websrvs -m file -a &#39;src&#x3D;&#x2F;data&#x2F;testfile dest&#x3D;&#x2F;data&#x2F;testfile-link state&#x3D;link&#39; 创建软链接</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">unarchive：解包解压缩，有两种用法：</span><br><span class="line">    1、将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy&#x3D;yes.</span><br><span class="line">    2、将远程主机上的某个压缩包解压缩到指定路径下，设置copy&#x3D;no</span><br><span class="line"></span><br><span class="line">    常见参数：</span><br><span class="line">        copy：默认为yes，当copy&#x3D;yes，拷贝的文件是从ansible主机复制到远程主机上，</span><br><span class="line">              如果设置为copy&#x3D;no，会在远程主机上寻找src源文件</span><br><span class="line">        src： 源路径，可以是ansible主机上的路径，也可以是远程主机上的路径，</span><br><span class="line">              如果是远程主机上的路径，则需要设置copy&#x3D;no</span><br><span class="line">        dest：远程主机上的目标路径</span><br><span class="line">        mode：设置解压缩后的文件权限</span><br><span class="line">    </span><br><span class="line">    示例：</span><br><span class="line">        ansible websrvs -m unarchive -a &#39;src&#x3D;foo.tgz dest&#x3D;&#x2F;var&#x2F;lib&#x2F;foo&#39;  </span><br><span class="line">          #默认copy为yes ,将本机目录文件解压到目标主机对应目录下</span><br><span class="line">        ansible websrvs -m unarchive -a &#39;src&#x3D;&#x2F;tmp&#x2F;foo.zip dest&#x3D;&#x2F;data copy&#x3D;no mode&#x3D;0777&#39;</span><br><span class="line">          # 解压被管理主机的foo.zip到data目录下, 并设置权限777</span><br><span class="line">        ansible websrvs -m unarchive -a &#39;src&#x3D;https:&#x2F;&#x2F;example.com&#x2F;example.zip dest&#x3D;&#x2F;data copy&#x3D;no&#39;</span><br><span class="line"></span><br><span class="line">Archive：打包压缩</span><br><span class="line">    &gt; ansible all -m archive -a &#39;path&#x3D;&#x2F;etc&#x2F;sysconfig dest&#x3D;&#x2F;data&#x2F;sysconfig.tar.bz2 format&#x3D;bz2 owner&#x3D;wang mode&#x3D;0777&#39;</span><br><span class="line">    将远程主机目录打包 </span><br><span class="line">        path:   指定路径</span><br><span class="line">        dest:   指定目标文件</span><br><span class="line">        format: 指定打包格式</span><br><span class="line">        owner:  指定所属者</span><br><span class="line">        mode:   设置权限</span><br><span class="line"></span><br><span class="line">Hostname：管理主机名</span><br><span class="line">    ansible appsrvs -m hostname -a &quot;name&#x3D;app.adong.com&quot;  更改一组的主机名</span><br><span class="line">    ansible 192.168.38.103 -m hostname -a &quot;name&#x3D;app2.adong.com&quot; 更改单个主机名</span><br><span class="line"></span><br><span class="line">Cron：计划任务</span><br><span class="line">    支持时间：minute,hour,day,month,weekday</span><br><span class="line">    &gt; ansible websrvs -m cron -a &quot;minute&#x3D;*&#x2F;5 job&#x3D;&#39;&#x2F;usr&#x2F;sbin&#x2F;ntpdate 172.16.0.1 &amp;&gt;&#x2F;dev&#x2F;null&#39; name&#x3D;Synctime&quot; </span><br><span class="line">    创建任务</span><br><span class="line">    &gt; ansible websrvs -m cron -a &#39;state&#x3D;absent name&#x3D;Synctime&#39; </span><br><span class="line">    删除任务</span><br><span class="line">    &gt; ansible websrvs -m cron -a &#39;minute&#x3D;*&#x2F;10 job&#x3D;&#39;&#x2F;usr&#x2F;sbin&#x2F;ntpdate 172.30.0.100&quot; name&#x3D;synctime disabled&#x3D;yes&#39;</span><br><span class="line">    注释任务,不在生效</span><br><span class="line"></span><br><span class="line">Yum：管理包</span><br><span class="line">    ansible websrvs -m yum -a &#39;list&#x3D;httpd&#39;  查看程序列表</span><br><span class="line">    </span><br><span class="line">    ansible websrvs -m yum -a &#39;name&#x3D;httpd state&#x3D;present&#39; 安装</span><br><span class="line">    ansible websrvs -m yum -a &#39;name&#x3D;httpd state&#x3D;absent&#39;  删除</span><br><span class="line">    可以同时安装多个程序包</span><br><span class="line">	操作注意；最新版本ansible使用python3，当更换Python后，yum模块就会报错</span><br><span class="line">	&#123;</span><br><span class="line">	    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;msg&quot;: &quot;The Python 2 bindings for rpm are needed for this module. If you require Python 3 support use the &#96;dnf&#96; Ansible module instead.. The Python 2 yum module is needed for this module. If you require Python 3 support use the &#96;dnf&#96; Ansible module instead.&quot;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">	通过强制使用python2解决ansible_python_interpreter&#x3D;&#x2F;usr&#x2F;bin&#x2F;python2了这个问题，在ansible清单文件中为这组主机添加，如以下代码段所示：</span><br><span class="line">	！！编辑时请通过组的形式进行配置，直接添加ansible_python_interpreter参数也是会报错的。</span><br><span class="line">	[amz_linux]</span><br><span class="line">	server2 ansible_host&#x3D;ec2-xx-yy-zz-pp.eu-west-1.compute.amazonaws.com</span><br><span class="line"></span><br><span class="line">	[amz_linux:vars]</span><br><span class="line">	ansible_user&#x3D;ec2-user</span><br><span class="line">	ansible_python_interpreter&#x3D;&#x2F;usr&#x2F;bin&#x2F;python2</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">Service：管理服务</span><br><span class="line">    ansible srv -m service -a &#39;name&#x3D;httpd state&#x3D;stopped&#39;  停止服务</span><br><span class="line">    ansible srv -m service -a &#39;name&#x3D;httpd state&#x3D;started enabled&#x3D;yes&#39; 启动服务,并设为开机自启</span><br><span class="line">    ansible srv -m service -a &#39;name&#x3D;httpd state&#x3D;reloaded&#39;  重新加载</span><br><span class="line">    ansible srv -m service -a &#39;name&#x3D;httpd state&#x3D;restarted&#39; 重启服务</span><br><span class="line"></span><br><span class="line">User：管理用户</span><br><span class="line">    home   指定家目录路径</span><br><span class="line">    system 指定系统账号</span><br><span class="line">    group  指定组</span><br><span class="line">    remove 清除账户</span><br><span class="line">    shell  指定shell类型</span><br><span class="line">    </span><br><span class="line">    ansible websrvs -m user -a &#39;name&#x3D;user1 comment&#x3D;&quot;test user&quot; uid&#x3D;2048 home&#x3D;&#x2F;app&#x2F;user1 group&#x3D;root&#39;</span><br><span class="line">    ansible websrvs -m user -a &#39;name&#x3D;sysuser1 system&#x3D;yes home&#x3D;&#x2F;app&#x2F;sysuser1&#39;</span><br><span class="line">    ansible websrvs -m user -a &#39;name&#x3D;user1 state&#x3D;absent remove&#x3D;yes&#39;  清空用户所有数据</span><br><span class="line">    ansible websrvs -m user -a &#39;name&#x3D;app uid&#x3D;88 system&#x3D;yes home&#x3D;&#x2F;app groups&#x3D;root shell&#x3D;&#x2F;sbin&#x2F;nologin password&#x3D;&quot;$1$zfVojmPy$ZILcvxnXljvTI2PhP2Iqv1&quot;&#39;  创建用户</span><br><span class="line">    ansible websrvs -m user -a &#39;name&#x3D;app state&#x3D;absent&#39;  不会删除家目录</span><br><span class="line">    </span><br><span class="line">    安装mkpasswd </span><br><span class="line">    yum insatll expect </span><br><span class="line">    mkpasswd 生成口令</span><br><span class="line">    openssl passwd -1  生成加密口令</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">删除用户及家目录等数据</span><br><span class="line">    Group：管理组</span><br><span class="line">        ansible srv -m group -a &quot;name&#x3D;testgroup system&#x3D;yes&quot;   创建组</span><br><span class="line">        ansible srv -m group -a &quot;name&#x3D;testgroup state&#x3D;absent&quot; 删除组</span><br></pre></td></tr></table></figure>

<h3 id="ansible系列命令-1"><a href="#ansible系列命令-1" class="headerlink" title="ansible系列命令"></a>ansible系列命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">可以通过网上写好的</span><br><span class="line">ansible-galaxy</span><br><span class="line">    &gt; 连接 https:&#x2F;&#x2F;galaxy.ansible.com </span><br><span class="line">      下载相应的roles(角色)</span><br><span class="line">    </span><br><span class="line">    &gt; 列出所有已安装的galaxy</span><br><span class="line">        ansible-galaxy list</span><br><span class="line">    </span><br><span class="line">    &gt; 安装galaxy</span><br><span class="line">        ansible-galaxy install geerlingguy.redis</span><br><span class="line">    </span><br><span class="line">    &gt; 删除galaxy</span><br><span class="line">        ansible-galaxy remove geerlingguy.redis</span><br><span class="line">        </span><br><span class="line">ansible-pull</span><br><span class="line">    推送命令至远程，效率无限提升，对运维要求较高</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">ansible-playbook  可以引用按照标准的yml语言写的脚本</span><br><span class="line">    执行playbook</span><br><span class="line">    示例：ansible-playbook hello.yml</span><br><span class="line">        cat hello.yml</span><br><span class="line">        #hello world yml file</span><br><span class="line">        - hosts: websrvs</span><br><span class="line">          remote_user: root</span><br><span class="line">          tasks:</span><br><span class="line">            - name: hello world</span><br><span class="line">              command: &#x2F;usr&#x2F;bin&#x2F;wall hello world</span><br><span class="line"></span><br><span class="line">ansible-vault  (了解)</span><br><span class="line">功能：管理加密解密yml文件</span><br><span class="line">    ansible-vault [create|decrypt|edit|encrypt|rekey|view]</span><br><span class="line">        ansible-vault encrypt hello.yml 加密</span><br><span class="line">        ansible-vault decrypt hello.yml 解密</span><br><span class="line">        ansible-vault view hello.yml    查看</span><br><span class="line">        ansible-vault edit hello.yml    编辑加密文件</span><br><span class="line">        ansible-vault rekey hello.yml   修改口令</span><br><span class="line">        ansible-vault create new.yml    创建新文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ansible-console：2.0+新增，可交互执行命令，支持tab  (了解)</span><br><span class="line"></span><br><span class="line">    root@test (2)[f:10] $</span><br><span class="line">    执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$</span><br><span class="line"></span><br><span class="line">    设置并发数：         forks n   例如： forks 10</span><br><span class="line">    切换组：             cd 主机组 例如： cd web</span><br><span class="line">    列出当前组主机列表： list</span><br><span class="line">    列出所有的内置命令： ?或help</span><br><span class="line">    示例：</span><br><span class="line">        root@all (2)[f:5]$ list</span><br><span class="line">        root@all (2)[f:5]$ cd appsrvs</span><br><span class="line">        root@appsrvs (2)[f:5]$ list</span><br><span class="line">        root@appsrvs (2)[f:5]$ yum name&#x3D;httpd state&#x3D;present</span><br><span class="line">        root@appsrvs (2)[f:5]$ service name&#x3D;httpd state&#x3D;started</span><br></pre></td></tr></table></figure>


<h3 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h3><p>使用源码安装的注意：<br>需要复制配置文件到/etc/ansible/ansible.cfg ，如果不操作这个步，执行playbook时由于无法读取配置文件，会报错无法连接到hosts</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; playbook是由一个或多个&quot;play&quot;组成的列表</span><br><span class="line">&gt; play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task定义好的角色。</span><br><span class="line">  Task实际是调用ansible的一个module，将多个play组织在一个playbook中，</span><br><span class="line">  即可以让它们联合起来，按事先编排的机制执行预定义的动作</span><br><span class="line">&gt; Playbook采用YAML语言编写</span><br></pre></td></tr></table></figure>
<h3 id="playbook图解"><a href="#playbook图解" class="headerlink" title="playbook图解"></a>playbook图解</h3><p><img src="https://note.youdao.com/yws/res/100098/FD38F2B4BE0B49578DCC4CB58E218543" alt="image">  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用户通过ansible命令直接调用yml语言写好的playbook,playbook由多条play组成</span><br><span class="line">每条play都有一个任务(task)相对应的操作,然后调用模块modules，应用在主机清单上,通过ssh远程连接</span><br><span class="line">从而控制远程主机或者网络设备</span><br></pre></td></tr></table></figure>

<h3 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">YAML是一个可读性高的用来表达资料序列的格式。</span><br><span class="line">    YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。</span><br><span class="line">    Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</span><br><span class="line"></span><br><span class="line">YAML Ain&#39;t Markup Language，即YAML不是XML。</span><br><span class="line">不过，在开发的这种语言时，YAML的意思其实是：&quot;Yet Another Markup Language&quot;（仍是一种标记语言）</span><br><span class="line"></span><br><span class="line">特性</span><br><span class="line">    YAML的可读性好</span><br><span class="line">    YAML和脚本语言的交互性好</span><br><span class="line">    YAML使用实现语言的数据类型</span><br><span class="line">    YAML有一个一致的信息模型</span><br><span class="line">    YAML易于实现</span><br><span class="line">    YAML可以基于流来处理</span><br><span class="line">    YAML表达能力强，扩展性好</span><br><span class="line"></span><br><span class="line">更多的内容及规范参见：http:&#x2F;&#x2F;www.yaml.org</span><br></pre></td></tr></table></figure>

<h3 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; 在单一档案中，可用连续三个连字号(——)区分多个档案。</span><br><span class="line">  另外，还有选择性的连续三个点号( ... )用来表示档案结尾</span><br><span class="line">&gt; 次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</span><br><span class="line">&gt; 使用#号注释代码</span><br><span class="line">&gt; 缩进必须是统一的，不能空格和tab混用</span><br><span class="line">&gt; 缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</span><br><span class="line">&gt; YAML文件内容是区别大小写的，k&#x2F;v的值均需大小写敏感</span><br><span class="line">&gt; 多个k&#x2F;v可同行写也可换行写，同行使用:分隔</span><br><span class="line">&gt; v可是个字符串，也可是另一个列表[]</span><br><span class="line">&gt; 一个完整的代码块功能需最少元素需包括 name 和 task</span><br><span class="line">&gt; 一个name只能包括一个task</span><br><span class="line">&gt; YAML文件扩展名通常为yml或yaml</span><br></pre></td></tr></table></figure>

<h3 id="YAML语法简介-1"><a href="#YAML语法简介-1" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">List：列表，其所有元素均使用“-”打头</span><br><span class="line">      列表代表同一类型的元素</span><br><span class="line">示例：</span><br><span class="line"># A list of tasty fruits</span><br><span class="line">- Apple</span><br><span class="line">- Orange</span><br><span class="line">- Strawberry</span><br><span class="line">- Mango</span><br><span class="line"></span><br><span class="line">Dictionary：字典，通常由多个key与value构成 键值对</span><br><span class="line">示例：</span><br><span class="line">---</span><br><span class="line"># An employee record</span><br><span class="line">name: Example Developer</span><br><span class="line">job: Developer</span><br><span class="line">skill: Elite</span><br><span class="line"></span><br><span class="line">也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span><br><span class="line">示例：</span><br><span class="line">---</span><br><span class="line"># An employee record</span><br><span class="line">&#123;name: Example Developer, job: Developer, skill: Elite&#125;  有空格</span><br></pre></td></tr></table></figure>

<h3 id="YAML语法"><a href="#YAML语法" class="headerlink" title="YAML语法"></a>YAML语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。</span><br><span class="line">其结构（Structure）通过空格来展示，序列（Sequence）里的项用&quot;-&quot;来代表，Map里的键值对用&quot;:&quot;分隔</span><br><span class="line">示例</span><br><span class="line">    name: John Smith</span><br><span class="line">    age: 41</span><br><span class="line">    gender: Male</span><br><span class="line">    spouse:</span><br><span class="line">      name: Jane Smith</span><br><span class="line">      age: 37</span><br><span class="line">      gender: Female</span><br><span class="line">    children:</span><br><span class="line">      - name: Jimmy Smith</span><br><span class="line">        age: 17</span><br><span class="line">        gender: Male</span><br><span class="line">      - name: Jenny Smith</span><br><span class="line">        age 13</span><br><span class="line">        gender: Female</span><br></pre></td></tr></table></figure>

<h3 id="三种常见的数据交换格式"><a href="#三种常见的数据交换格式" class="headerlink" title="三种常见的数据交换格式"></a>三种常见的数据交换格式</h3><p><img src="https://note.youdao.com/yws/res/100106/8B5EADE22C804A65A1D9027206BD15F4" alt="image"></p>
<h3 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Hosts          执行的远程主机列表(应用在哪些主机上)</span><br><span class="line"></span><br><span class="line">Tasks          任务集</span><br><span class="line"></span><br><span class="line">Variables      内置变量或自定义变量在playbook中调用</span><br><span class="line"></span><br><span class="line">Templates模板  可替换模板文件中的变量并实现一些简单逻辑的文件</span><br><span class="line"></span><br><span class="line">Handlers和notify结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</span><br><span class="line"></span><br><span class="line">tags标签       指定某条任务执行，用于选择运行playbook中的部分代码。</span><br><span class="line">                ansible具有幂等性，因此会自动跳过没有变化的部分，</span><br><span class="line">                即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。</span><br><span class="line">                此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</span><br><span class="line">                ansible-playbook -t tagsname useradd.yml</span><br></pre></td></tr></table></figure>

<h3 id="playbook基础组件"><a href="#playbook基础组件" class="headerlink" title="playbook基础组件"></a>playbook基础组件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Hosts：</span><br><span class="line">    &gt; playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。</span><br><span class="line">      hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</span><br><span class="line"></span><br><span class="line">    &gt; 可以是如下形式：</span><br><span class="line">        one.example.com</span><br><span class="line">        one.example.com:two.example.com</span><br><span class="line">        192.168.1.50</span><br><span class="line">        192.168.1.*</span><br><span class="line">    &gt; Websrvs:dbsrvs       或者，两个组的并集</span><br><span class="line">    &gt; Websrvs:&amp;dbsrvs      与，两个组的交集</span><br><span class="line">    &gt; webservers:!phoenix  在websrvs组，但不在dbsrvs组</span><br><span class="line">    示例: - hosts: websrvs：dbsrvs</span><br><span class="line"></span><br><span class="line">remote_user: </span><br><span class="line">    可用于Host和task中。</span><br><span class="line">    也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；</span><br><span class="line">    此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</span><br><span class="line">    - hosts: websrvs</span><br><span class="line">        remote_user: root   (可省略,默认为root)  以root身份连接</span><br><span class="line">      tasks:    指定任务</span><br><span class="line">    - name: test connection</span><br><span class="line">        ping:</span><br><span class="line">        remote_user: magedu</span><br><span class="line">        sudo: yes           默认sudo为root</span><br><span class="line">        sudo_user:wang      sudo为wang</span><br><span class="line">    </span><br><span class="line">task列表和action</span><br><span class="line">    任务列表task:由多个动作,多个任务组合起来的,每个任务都调用的模块,一个模块一个模块执行</span><br><span class="line">    1&gt; play的主体部分是task list，task list中的各任务按次序逐个在hosts中指定的所有主机上执行，</span><br><span class="line">       即在所有主机上完成第一个任务后，再开始第二个任务</span><br><span class="line"></span><br><span class="line">    2&gt; task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。</span><br><span class="line">       模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</span><br><span class="line"></span><br><span class="line">    3&gt; 每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。</span><br><span class="line">       如果未提供name，则action的结果将用于输出</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tasks：任务列表</span><br><span class="line">两种格式：</span><br><span class="line">    (1) action: module arguments</span><br><span class="line">    (2) module: arguments 建议使用  模块: 参数</span><br><span class="line">    注意：shell和command模块后面跟命令，而非key&#x3D;value</span><br><span class="line"></span><br><span class="line">某任务的状态在运行后为changed时，可通过&quot;notify&quot;通知给相应的handlers</span><br><span class="line"></span><br><span class="line">任务可以通过&quot;tags&quot;打标签，可在ansible-playbook命令上使用-t指定进行调用</span><br><span class="line">示例：</span><br><span class="line">tasks:</span><br><span class="line">  - name: disable selinux   描述</span><br><span class="line">    command: &#x2F;sbin&#x2F;setenforce 0   模块名: 模块对应的参数</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">如果命令或脚本的退出码不为零，可以使用如下方式替代</span><br><span class="line">tasks:</span><br><span class="line">  - name: run this command and ignore the result</span><br><span class="line">    shell: &#x2F;usr&#x2F;bin&#x2F;somecommand || &#x2F;bin&#x2F;true  </span><br><span class="line">    转错为正  如果命令失败则执行 true</span><br><span class="line"></span><br><span class="line">或者使用ignore_errors来忽略错误信息</span><br><span class="line">tasks:</span><br><span class="line">  - name: run this command and ignore the result</span><br><span class="line">    shell: &#x2F;usr&#x2F;bin&#x2F;somecommand</span><br><span class="line">    ignore_errors: True  忽略错误</span><br></pre></td></tr></table></figure>

<h3 id="运行playbook"><a href="#运行playbook" class="headerlink" title="运行playbook"></a>运行playbook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">运行playbook的方式</span><br><span class="line">    ansible-playbook &lt;filename.yml&gt; ... [options]</span><br><span class="line"></span><br><span class="line">常见选项</span><br><span class="line">    --check -C       只检测可能会发生的改变，但不真正执行操作 </span><br><span class="line">                     (只检查语法,如果执行过程中出现问题,-C无法检测出来)</span><br><span class="line">                     (执行playbook生成的文件不存在,后面的程序如果依赖这些文件,也会导致检测失败)</span><br><span class="line">    --list-hosts     列出运行任务的主机</span><br><span class="line">    --list-tags      列出tag  (列出标签)</span><br><span class="line">    --list-tasks     列出task (列出任务)</span><br><span class="line">    --limit 主机列表 只针对主机列表中的主机执行</span><br><span class="line">    -v -vv -vvv      显示过程</span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">    ansible-playbook hello.yml --check 只检测</span><br><span class="line">    ansible-playbook hello.yml --list-hosts  显示运行任务的主机</span><br><span class="line">    ansible-playbook hello.yml --limit websrvs  限制主机</span><br></pre></td></tr></table></figure>

<h3 id="Playbook-VS-ShellScripts"><a href="#Playbook-VS-ShellScripts" class="headerlink" title="Playbook VS ShellScripts"></a>Playbook VS ShellScripts</h3><p>安装httpd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SHELL脚本</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"># 安装Apache</span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"># 复制配置文件</span><br><span class="line">cp &#x2F;tmp&#x2F;httpd.conf &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">cp&#x2F;tmp&#x2F;vhosts.conf &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;</span><br><span class="line"># 启动Apache，并设置开机启动</span><br><span class="line">service httpd start</span><br><span class="line">chkconfig httpd on</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Playbook定义</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: &quot;安装Apache&quot;</span><br><span class="line">      yum: name&#x3D;httpd       yum模块:安装httpd</span><br><span class="line">    - name: &quot;复制配置文件&quot;</span><br><span class="line">      copy: src&#x3D;&#x2F;tmp&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;  copy模块: 拷贝文件</span><br><span class="line">    - name: &quot;复制配置文件&quot;</span><br><span class="line">      copy: src&#x3D;&#x2F;tmp&#x2F;vhosts.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;  </span><br><span class="line">    - name: &quot;启动Apache，并设置开机启动&quot;</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;started enabled&#x3D;yes   service模块: 启动服务</span><br></pre></td></tr></table></figure>

<h3 id="示例-Playbook-创建用户"><a href="#示例-Playbook-创建用户" class="headerlink" title="示例:Playbook 创建用户"></a>示例:Playbook 创建用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">示例：sysuser.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: create mysql user</span><br><span class="line">      user: name&#x3D;mysql system&#x3D;yes uid&#x3D;36</span><br><span class="line">    - name: create a group</span><br><span class="line">      group: name&#x3D;httpd system&#x3D;yes</span><br></pre></td></tr></table></figure>

<h3 id="Playbook示例-安装httpd服务"><a href="#Playbook示例-安装httpd服务" class="headerlink" title="Playbook示例  安装httpd服务"></a>Playbook示例  安装httpd服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">示例：httpd.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install httpd</span><br><span class="line">      yum: name&#x3D;httpd state&#x3D;present</span><br><span class="line">    - name: Install configure file</span><br><span class="line">      copy: src&#x3D;files&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;</span><br><span class="line">    - name: start service</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;started enabled&#x3D;yes</span><br></pre></td></tr></table></figure>

<h3 id="Playbook示例-安装nginx服务"><a href="#Playbook示例-安装nginx服务" class="headerlink" title="Playbook示例  安装nginx服务"></a>Playbook示例  安装nginx服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">示例 nginx.yml</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: add group nginx</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: add user nginx</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present group&#x3D;nginx</span><br><span class="line">    - name: Install Nginx</span><br><span class="line">      yum: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: Start Nginx</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;started enabled&#x3D;yes</span><br></pre></td></tr></table></figure>

<h3 id="handlers和notify结合使用触发条件"><a href="#handlers和notify结合使用触发条件" class="headerlink" title="handlers和notify结合使用触发条件"></a>handlers和notify结合使用触发条件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Handlers 实际上就是一个触发器</span><br><span class="line">是task列表，这些task与前述的task并没有本质上的不同,用于当关注的资源发生变化时，才会采取一定的操作</span><br><span class="line"></span><br><span class="line">Notify此action可用于在每个play的最后被触发，</span><br><span class="line">这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。</span><br><span class="line">在notify中列出的操作称为handler，也即notify中调用handler中定义的操作</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中handlers使用"><a href="#Playbook中handlers使用" class="headerlink" title="Playbook中handlers使用"></a>Playbook中handlers使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install httpd</span><br><span class="line">      yum: name&#x3D;httpd state&#x3D;present</span><br><span class="line">    - name: Install configure file</span><br><span class="line">      copy: src&#x3D;files&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;</span><br><span class="line">      notify: restart httpd</span><br><span class="line">    - name: ensure apache is running</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;started enabled&#x3D;yes</span><br><span class="line">  </span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart httpd</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;restarted</span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- hosts: webnodes</span><br><span class="line">  vars:</span><br><span class="line">    http_port: 80</span><br><span class="line">    max_clients: 256</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: ensure apache is at the latest version</span><br><span class="line">      yum: name&#x3D;httpd state&#x3D;latest</span><br><span class="line">    - name: ensure apache is running</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;started</span><br><span class="line">    - name: Install configure file</span><br><span class="line">      copy: src&#x3D;files&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;</span><br><span class="line">      notify: restart httpd</span><br><span class="line">  </span><br><span class="line">  handlers:</span><br><span class="line">      - name: restart httpd </span><br><span class="line">        service: name&#x3D;httpd state&#x3D;restarted</span><br></pre></td></tr></table></figure>

<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: add group nginx</span><br><span class="line">      tags: user</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: add user nginx</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present group&#x3D;nginx</span><br><span class="line">    - name: Install Nginx</span><br><span class="line">      yum: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: config</span><br><span class="line">      copy: src&#x3D;&#x2F;root&#x2F;config.txt dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">      notify:</span><br><span class="line">        - Restart Nginx</span><br><span class="line">        - Check Nginx Process</span><br><span class="line">  </span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Nginx</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;restarted enabled&#x3D;yes</span><br><span class="line">    - name: Check Nginx process</span><br><span class="line">      shell: killall -0 nginx &gt; &#x2F;tmp&#x2F;nginx.log</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中tags使用"><a href="#Playbook中tags使用" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">tage: 添加标签 </span><br><span class="line">可以指定某一个任务添加一个标签,添加标签以后,想执行某个动作可以做出挑选来执行</span><br><span class="line">多个动作可以使用同一个标签</span><br><span class="line"></span><br><span class="line">示例：httpd.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install httpd</span><br><span class="line">      yum: name&#x3D;httpd state&#x3D;present</span><br><span class="line">      tage: install </span><br><span class="line">    - name: Install configure file</span><br><span class="line">      copy: src&#x3D;files&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;</span><br><span class="line">      tags: conf</span><br><span class="line">    - name: start httpd service</span><br><span class="line">      tags: service</span><br><span class="line">      service: name&#x3D;httpd state&#x3D;started enabled&#x3D;yes</span><br><span class="line"></span><br><span class="line">ansible-playbook –t install,conf httpd.yml   指定执行install,conf 两个标签</span><br></pre></td></tr></table></figure>

<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;heartbeat.yaml</span><br><span class="line">- hosts: hbhosts</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: ensure heartbeat latest version</span><br><span class="line">      yum: name&#x3D;heartbeat state&#x3D;present</span><br><span class="line">    - name: authkeys configure file</span><br><span class="line">      copy: src&#x3D;&#x2F;root&#x2F;hb_conf&#x2F;authkeys dest&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;authkeys</span><br><span class="line">    - name: authkeys mode 600</span><br><span class="line">      file: path&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;authkeys mode&#x3D;600</span><br><span class="line">      notify:</span><br><span class="line">        - restart heartbeat</span><br><span class="line">    - name: ha.cf configure file</span><br><span class="line">      copy: src&#x3D;&#x2F;root&#x2F;hb_conf&#x2F;ha.cf dest&#x3D;&#x2F;etc&#x2F;ha.d&#x2F;ha.cf</span><br><span class="line">      notify:</span><br><span class="line">        - restart heartbeat</span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart heartbeat</span><br><span class="line">      service: name&#x3D;heartbeat state&#x3D;restarted</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中tags使用-1"><a href="#Playbook中tags使用-1" class="headerlink" title="Playbook中tags使用"></a>Playbook中tags使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- hosts: testsrv</span><br><span class="line">  remote_user: root</span><br><span class="line">  tags: inshttpd   针对整个playbook添加tage</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install httpd</span><br><span class="line">      yum: name&#x3D;httpd state&#x3D;present</span><br><span class="line">    - name: Install configure file</span><br><span class="line">      copy: src&#x3D;files&#x2F;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;</span><br><span class="line">      tags: rshttpd</span><br><span class="line">      notify: restart httpd</span><br><span class="line">  handlers:</span><br><span class="line">    - name: restart httpd</span><br><span class="line">      service: name&#x3D;httpd status&#x3D;restarted</span><br><span class="line">     </span><br><span class="line">ansible-playbook –t rshttpd httpd2.yml</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中变量的使用"><a href="#Playbook中变量的使用" class="headerlink" title="Playbook中变量的使用"></a>Playbook中变量的使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">变量名：仅能由字母、数字和下划线组成，且只能以字母开头</span><br><span class="line">变量来源：</span><br><span class="line">    1&gt; ansible setup facts 远程主机的所有变量都可直接调用 (系统自带变量)</span><br><span class="line">       setup模块可以实现系统中很多系统信息的显示</span><br><span class="line">                可以返回每个主机的系统信息包括:版本、主机名、cpu、内存</span><br><span class="line">       ansible all -m setup -a &#39;filter&#x3D;&quot;ansible_nodename&quot;&#39;     查询主机名</span><br><span class="line">       ansible all -m setup -a &#39;filter&#x3D;&quot;ansible_memtotal_mb&quot;&#39;  查询主机内存大小</span><br><span class="line">       ansible all -m setup -a &#39;filter&#x3D;&quot;ansible_distribution_major_version&quot;&#39;  查询系统版本</span><br><span class="line">       ansible all -m setup -a &#39;filter&#x3D;&quot;ansible_processor_vcpus&quot;&#39; 查询主机cpu个数</span><br><span class="line">    </span><br><span class="line">    2&gt; 在&#x2F;etc&#x2F;ansible&#x2F;hosts(主机清单)中定义变量</span><br><span class="line">        普通变量：主机组中主机单独定义，优先级高于公共变量(单个主机 )</span><br><span class="line">        公共(组)变量：针对主机组中所有主机定义统一变量(一组主机的同一类别)</span><br><span class="line">    </span><br><span class="line">    3&gt; 通过命令行指定变量，优先级最高</span><br><span class="line">       ansible-playbook –e varname&#x3D;value</span><br><span class="line">    </span><br><span class="line">    4&gt; 在playbook中定义</span><br><span class="line">       vars:</span><br><span class="line">        - var1: value1</span><br><span class="line">        - var2: value2</span><br><span class="line">    </span><br><span class="line">    5&gt; 在独立的变量YAML文件中定义</span><br><span class="line">    </span><br><span class="line">    6&gt; 在role中定义</span><br><span class="line"></span><br><span class="line">变量命名:</span><br><span class="line">    变量名仅能由字母、数字和下划线组成，且只能以字母开头</span><br><span class="line"></span><br><span class="line">变量定义：key&#x3D;value</span><br><span class="line">    示例：http_port&#x3D;80</span><br><span class="line"></span><br><span class="line">变量调用方式：</span><br><span class="line">    1&gt; 通过&#123;&#123; variable_name &#125;&#125; 调用变量，且变量名前后必须有空格，有时用“&#123;&#123; variable_name &#125;&#125;”才生效</span><br><span class="line"></span><br><span class="line">    2&gt; ansible-playbook –e 选项指定</span><br><span class="line">       ansible-playbook test.yml -e &quot;hosts&#x3D;www user&#x3D;magedu&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">在主机清单中定义变量,在ansible中使用变量</span><br><span class="line">vim &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">[appsrvs]</span><br><span class="line">192.168.38.17 http_port&#x3D;817 name&#x3D;www</span><br><span class="line">192.168.38.27 http_port&#x3D;827 name&#x3D;web</span><br><span class="line"></span><br><span class="line">调用变量</span><br><span class="line">ansible appsrvs -m hostname -a&#39;name&#x3D;&#123;&#123;name&#125;&#125;&#39;  更改主机名为各自被定义的变量 </span><br><span class="line"></span><br><span class="line">针对一组设置变量</span><br><span class="line">[appsrvs:vars]</span><br><span class="line">make&#x3D;&quot;-&quot;</span><br><span class="line"></span><br><span class="line">ansible appsrvs -m hostname -a &#39;name&#x3D;&#123;&#123;name&#125;&#125;&#123;&#123;mark&#125;&#125;&#123;&#123;http_port&#125;&#125;&#39;  ansible调用变量</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">将变量写进单独的配置文件中引用</span><br><span class="line">vim vars.yml</span><br><span class="line">pack: vsftpd</span><br><span class="line">service: vsftpd</span><br><span class="line"></span><br><span class="line">引用变量文件</span><br><span class="line">vars_files:</span><br><span class="line">  - vars.yml</span><br></pre></td></tr></table></figure>

<h3 id="Ansible基础元素"><a href="#Ansible基础元素" class="headerlink" title="Ansible基础元素"></a>Ansible基础元素</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Facts：是由正在通信的远程目标主机发回的信息，这些信息被保存在ansible变量中。</span><br><span class="line">       要获取指定的远程主机所支持的所有facts，可使用如下命令进行</span><br><span class="line">       ansible websrvs -m setup</span><br><span class="line"></span><br><span class="line">通过命令行传递变量</span><br><span class="line">    在运行playbook的时候也可以传递一些变量供playbook使用</span><br><span class="line">    示例：</span><br><span class="line">        ansible-playbook test.yml -e &quot;hosts&#x3D;www user&#x3D;magedu&quot;</span><br><span class="line">        </span><br><span class="line">register</span><br><span class="line">把任务的输出定义为变量，然后用于其他任务</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">tasks:</span><br><span class="line">- shell: &#x2F;usr&#x2F;bin&#x2F;foo</span><br><span class="line">  register: foo_result</span><br><span class="line">  ignore_errors: True</span><br></pre></td></tr></table></figure>

<h3 id="示例：使用setup变量"><a href="#示例：使用setup变量" class="headerlink" title="示例：使用setup变量"></a>示例：使用setup变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">示例：var.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create log file</span><br><span class="line">      file: name&#x3D;&#x2F;var&#x2F;log&#x2F; &#123;&#123; ansible_fqdn &#125;&#125; state&#x3D;touch</span><br><span class="line"></span><br><span class="line">ansible-playbook var.yml</span><br></pre></td></tr></table></figure>

<h3 id="示例：变量"><a href="#示例：变量" class="headerlink" title="示例：变量"></a>示例：变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">示例：var.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum: name&#x3D;&#123;&#123; pkname &#125;&#125; state&#x3D;present</span><br><span class="line">      </span><br><span class="line">ansible-playbook –e pkname&#x3D;httpd var.yml</span><br></pre></td></tr></table></figure>

<h3 id="示例：变量-1"><a href="#示例：变量-1" class="headerlink" title="示例：变量"></a>示例：变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">示例：var.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">vars:</span><br><span class="line">  - username: user1</span><br><span class="line">  - groupname: group1</span><br><span class="line">tasks:</span><br><span class="line">  - name: create group</span><br><span class="line">    group: name&#x3D;&#123;&#123; groupname &#125;&#125; state&#x3D;present</span><br><span class="line">  - name: create user</span><br><span class="line">    user: name&#x3D;&#123;&#123; username &#125;&#125; state&#x3D;present</span><br><span class="line"></span><br><span class="line">ansible-playbook var.yml</span><br><span class="line">ansible-playbook -e &quot;username&#x3D;user2 groupname&#x3D;group2” var2.yml</span><br></pre></td></tr></table></figure>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">主机变量</span><br><span class="line">可以在inventory中定义主机时为其添加主机变量以便于在playbook中使用</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">[websrvs]</span><br><span class="line">www1.magedu.com http_port&#x3D;80 maxRequestsPerChild&#x3D;808</span><br><span class="line">www2.magedu.com http_port&#x3D;8080 maxRequestsPerChild&#x3D;909</span><br><span class="line"></span><br><span class="line">组变量</span><br><span class="line">组变量是指赋予给指定组内所有主机上的在playbook中可用的变量</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">    [websrvs]</span><br><span class="line">    www1.magedu.com</span><br><span class="line">    www2.magedu.com</span><br><span class="line"></span><br><span class="line">    [websrvs:vars]</span><br><span class="line">    ntp_server&#x3D;ntp.magedu.com</span><br><span class="line">    nfs_server&#x3D;nfs.magedu.com</span><br></pre></td></tr></table></figure>

<h3 id="示例：变量-2"><a href="#示例：变量-2" class="headerlink" title="示例：变量"></a>示例：变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">普通变量</span><br><span class="line">    [websrvs]</span><br><span class="line">    192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1</span><br><span class="line">    192.168.99.102 http_port&#x3D;80 hname&#x3D;www2</span><br><span class="line"></span><br><span class="line">公共（组）变量</span><br><span class="line">    [websvrs:vars]</span><br><span class="line">    http_port&#x3D;808</span><br><span class="line">    mark&#x3D;&quot;_&quot;</span><br><span class="line">    [websrvs]</span><br><span class="line">    192.168.99.101 http_port&#x3D;8080 hname&#x3D;www1</span><br><span class="line">    192.168.99.102 http_port&#x3D;80 hname&#x3D;www2</span><br><span class="line">    ansible websvrs –m hostname –a ‘name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;’</span><br><span class="line"></span><br><span class="line">命令行指定变量：</span><br><span class="line">    ansible websvrs –e http_port&#x3D;8000 –m hostname –a&#39;name&#x3D;&#123;&#123; hname &#125;&#125;&#123;&#123; mark &#125;&#125;&#123;&#123; http_port &#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<h3 id="使用变量文件"><a href="#使用变量文件" class="headerlink" title="使用变量文件"></a>使用变量文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cat vars.yml</span><br><span class="line">var1: httpd</span><br><span class="line">var2: nginx</span><br><span class="line"></span><br><span class="line">cat var.yml</span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: create httpd log</span><br><span class="line">      file: name&#x3D;&#x2F;app&#x2F;&#123;&#123; var1 &#125;&#125;.log state&#x3D;touch</span><br><span class="line">    - name: create nginx log</span><br><span class="line">      file: name&#x3D;&#x2F;app&#x2F;&#123;&#123; var2 &#125;&#125;.log state&#x3D;touch</span><br><span class="line">      </span><br><span class="line">hostname app_81.magedu.com  hostname 不支持&quot;_&quot;,认为&quot;_&quot;是非法字符</span><br><span class="line">hostnamectl set-hostname app_80.magedu.com  可以更改主机名</span><br></pre></td></tr></table></figure>

<h3 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">组嵌套</span><br><span class="line">inventory中，组还可以包含其它的组，并且也可以向组中的主机指定变量。</span><br><span class="line">这些变量只能在ansible-playbook中使用，而ansible命令不支持</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">    [apache]</span><br><span class="line">    httpd1.magedu.com</span><br><span class="line">    httpd2.magedu.com</span><br><span class="line">    </span><br><span class="line">    [nginx]</span><br><span class="line">    ngx1.magedu.com</span><br><span class="line">    ngx2.magedu.com</span><br><span class="line">    </span><br><span class="line">    [websrvs:children]</span><br><span class="line">    apache</span><br><span class="line">    nginx</span><br><span class="line">    </span><br><span class="line">    [webservers:vars]</span><br><span class="line">    ntp_server&#x3D;ntp.magedu.com</span><br></pre></td></tr></table></figure>

<h3 id="invertory参数"><a href="#invertory参数" class="headerlink" title="invertory参数"></a>invertory参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">invertory参数：用于定义ansible远程连接目标主机时使用的参数，而非传递给playbook的变量</span><br><span class="line">    ansible_ssh_host</span><br><span class="line">    ansible_ssh_port</span><br><span class="line">    ansible_ssh_user</span><br><span class="line">    ansible_ssh_pass</span><br><span class="line">    ansbile_sudo_pass</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">    cat &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">    [websrvs]</span><br><span class="line">    192.168.0.1 ansible_ssh_user&#x3D;root ansible_ssh_pass&#x3D;magedu</span><br><span class="line">    192.168.0.2 ansible_ssh_user&#x3D;root ansible_ssh_pass&#x3D;magedu</span><br></pre></td></tr></table></figure>

<h3 id="invertory参数-1"><a href="#invertory参数-1" class="headerlink" title="invertory参数"></a>invertory参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">inventory参数</span><br><span class="line">ansible基于ssh连接inventory中指定的远程主机时，还可以通过参数指定其交互方式；</span><br><span class="line">这些参数如下所示：</span><br><span class="line">ansible_ssh_host</span><br><span class="line">The name of the host to connect to, if different from the alias you wishto give to it.</span><br><span class="line"></span><br><span class="line">ansible_ssh_port</span><br><span class="line">The ssh port number, if not 22</span><br><span class="line"></span><br><span class="line">ansible_ssh_user</span><br><span class="line">The default ssh user name to use.</span><br><span class="line"></span><br><span class="line">ansible_ssh_pass</span><br><span class="line">The ssh password to use (this is insecure, we strongly recommendusing --ask-pass or SSH keys)</span><br><span class="line"></span><br><span class="line">ansible_sudo_pass</span><br><span class="line">The sudo password to use (this is insecure, we strongly recommendusing --ask-sudo-pass)</span><br><span class="line"></span><br><span class="line">ansible_connection</span><br><span class="line">Connection type of the host. Candidates are local, ssh or paramiko.</span><br><span class="line">The default is paramiko before Ansible 1.2, and &#39;smart&#39; afterwards which</span><br><span class="line">detects whether usage of &#39;ssh&#39; would be feasible based on whether</span><br><span class="line">ControlPersist is supported.</span><br><span class="line"></span><br><span class="line">ansible_ssh_private_key_file</span><br><span class="line">Private key file used by ssh. Useful if using multiple keys and you don&#39;t want to use SSH agent.</span><br><span class="line"></span><br><span class="line">ansible_shell_type</span><br><span class="line">The shell type of the target system. By default commands are formatted</span><br><span class="line">using &#39;sh&#39;-style syntax by default. Setting this to &#39;csh&#39; or &#39;fish&#39; will cause</span><br><span class="line">commands executed on target systems to follow those shell&#39;s syntax instead.</span><br><span class="line"></span><br><span class="line">ansible_python_interpreter</span><br><span class="line">The target host python path. This is useful for systems with more</span><br><span class="line">than one Python or not located at &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot; such as \*BSD, or where &#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line"></span><br><span class="line">is not a 2.X series Python. We do not use the &quot;&#x2F;usr&#x2F;bin&#x2F;env&quot; mechanism as that requires the remote user&#39;s</span><br><span class="line"></span><br><span class="line">path to be set right and also assumes the &quot;python&quot; executable is named python,where the executable might</span><br><span class="line"></span><br><span class="line">be named something like &quot;python26&quot;.</span><br><span class="line">ansible\_\*\_interpreter</span><br><span class="line"></span><br><span class="line">Works for anything such as ruby or perl and works just like ansible_python_interpreter.</span><br><span class="line"></span><br><span class="line">This replaces shebang of modules which will run on that host.</span><br></pre></td></tr></table></figure>

<h3 id="模板templates"><a href="#模板templates" class="headerlink" title="模板templates"></a>模板templates</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">文本文件，嵌套有脚本（使用模板编程语言编写） 借助模板生成真正的文件</span><br><span class="line">Jinja2语言，使用字面量，有下面形式</span><br><span class="line">    字符串：使用单引号或双引号</span><br><span class="line">    数字：整数，浮点数</span><br><span class="line">    列表：[item1, item2, ...]</span><br><span class="line">    元组：(item1, item2, ...)</span><br><span class="line">    字典：&#123;key1:value1, key2:value2, ...&#125;</span><br><span class="line">    布尔型：true&#x2F;false</span><br><span class="line">算术运算：+, -, *, &#x2F;, &#x2F;&#x2F;, %, **</span><br><span class="line">比较操作：&#x3D;&#x3D;, !&#x3D;, &gt;, &gt;&#x3D;, &lt;, &lt;&#x3D;</span><br><span class="line">逻辑运算：and，or，not</span><br><span class="line">流表达式：For，If，When</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2相关"><a href="#Jinja2相关" class="headerlink" title="Jinja2相关"></a>Jinja2相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">字面量</span><br><span class="line">    1&gt; 表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python对象。如“Hello World”</span><br><span class="line">    双引号或单引号中间的一切都是字符串。</span><br><span class="line">    2&gt; 无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如4242.23</span><br><span class="line">    3&gt; 数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在Python 里， 42 和 42.0 是不一样的</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2-算术运算"><a href="#Jinja2-算术运算" class="headerlink" title="Jinja2:算术运算"></a>Jinja2:算术运算</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">算术运算</span><br><span class="line">Jinja 允许你用计算值。这在模板中很少用到，但为了完整性允许其存在</span><br><span class="line">支持下面的运算符</span><br><span class="line">    +：把两个对象加到一起。</span><br><span class="line">       通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接它们。</span><br><span class="line">       无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 &#123;&#123; 1 + 1 &#125;&#125; 等于 2</span><br><span class="line">    -：用第一个数减去第二个数。 &#123;&#123; 3 - 2 &#125;&#125; 等于 1</span><br><span class="line">    &#x2F;：对两个数做除法。返回值会是一个浮点数。 &#123;&#123; 1 &#x2F; 2 &#125;&#125; 等于 &#123;&#123; 0.5 &#125;&#125;</span><br><span class="line">    &#x2F;&#x2F;：对两个数做除法，返回整数商。 &#123;&#123; 20 &#x2F;&#x2F; 7 &#125;&#125; 等于 2</span><br><span class="line">    %：计算整数除法的余数。 &#123;&#123; 11 % 7 &#125;&#125; 等于 4</span><br><span class="line">    *：用右边的数乘左边的操作数。 &#123;&#123; 2 * 2 &#125;&#125; 会返回 4 。</span><br><span class="line">       也可以用于重 复一个字符串多次。&#123;&#123; ‘&#x3D;’ * 80 &#125;&#125; 会打印 80 个等号的横条</span><br><span class="line">    **：取左操作数的右操作数次幂。 &#123;&#123; 2**3 &#125;&#125; 会返回 8</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2"><a href="#Jinja2" class="headerlink" title="Jinja2"></a>Jinja2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">比较操作符</span><br><span class="line">&#x3D;&#x3D; 比较两个对象是否相等</span><br><span class="line">!&#x3D; 比较两个对象是否不等</span><br><span class="line">&gt; 如果左边大于右边，返回 true</span><br><span class="line">&gt;&#x3D; 如果左边大于等于右边，返回 true</span><br><span class="line">&lt; 如果左边小于右边，返回 true</span><br><span class="line">&lt;&#x3D; 如果左边小于等于右边，返回 true</span><br><span class="line"></span><br><span class="line">逻辑运算符</span><br><span class="line">对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式</span><br><span class="line">and</span><br><span class="line">    如果左操作数和右操作数同为真，返回 true</span><br><span class="line">or</span><br><span class="line">    如果左操作数和右操作数有一个为真，返回 true</span><br><span class="line">not</span><br><span class="line">    对一个表达式取反（见下）</span><br><span class="line">(expr)</span><br><span class="line">    表达式组</span><br><span class="line"></span><br><span class="line">[&#39;list&#39;, &#39;of&#39;, &#39;objects&#39;]:</span><br><span class="line">一对中括号括起来的东西是一个列表。列表用于存储和迭代序列化的数据。</span><br><span class="line">例如 你可以容易地在 for循环中用列表和元组创建一个链接的列表</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">    &#123;% for href, caption in [(&#39;index.html&#39;, &#39;Index&#39;), (&#39;about.html&#39;, &#39;About&#39;), (&#39;downloads.html&#39;,</span><br><span class="line">&#39;Downloads&#39;)] %&#125;</span><br><span class="line">        &lt;li&gt;&lt;a href&#x3D;&quot;&#123;&#123; href &#125;&#125;&quot;&gt;&#123;&#123; caption &#125;&#125;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    &lt;&#x2F;ul&gt;</span><br><span class="line">    (&#39;tuple&#39;, &#39;of&#39;, &#39;values&#39;):</span><br><span class="line"></span><br><span class="line">元组与列表类似，只是你不能修改元组。</span><br><span class="line">如果元组中只有一个项，你需要以逗号结尾它。</span><br><span class="line">元组通常用于表示两个或更多元素的项。更多细节见上面的例子</span><br><span class="line">    &#123;&#39;dict&#39;: &#39;of&#39;, &#39;key&#39;: &#39;and&#39;, &#39;value&#39;: &#39;pairs&#39;&#125;:</span><br><span class="line"></span><br><span class="line">Python 中的字典是一种关联键和值的结构。</span><br><span class="line">键必须是唯一的，并且键必须只有一个 值。</span><br><span class="line">字典在模板中很少使用，罕用于诸如 xmlattr() 过滤器之类</span><br><span class="line">    true &#x2F; false:</span><br><span class="line">    true 永远是 true ，而 false 始终是 false</span><br></pre></td></tr></table></figure>

<h3 id="template-的使用"><a href="#template-的使用" class="headerlink" title="template 的使用"></a>template 的使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">template功能：根据模块文件动态生成对应的配置文件</span><br><span class="line">   &gt; template文件必须存放于templates目录下，且命名为 .j2 结尾</span><br><span class="line">   &gt; yaml&#x2F;yml 文件需和templates目录平级，目录结构如下：</span><br><span class="line">    .&#x2F;</span><br><span class="line">     ├── temnginx.yml</span><br><span class="line">     └── templates</span><br><span class="line">        └── nginx.conf.j2</span><br></pre></td></tr></table></figure>

<h3 id="template示例"><a href="#template示例" class="headerlink" title="template示例"></a>template示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">示例：利用template 同步nginx配置文件</span><br><span class="line">准备templates&#x2F;nginx.conf.j2文件</span><br><span class="line">vim temnginx.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config to remote hosts</span><br><span class="line">      template: src&#x3D;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx.yml</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中template变更替换"><a href="#Playbook中template变更替换" class="headerlink" title="Playbook中template变更替换"></a>Playbook中template变更替换</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">修改文件nginx.conf.j2 下面行为</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class="line"></span><br><span class="line">cat temnginx2.yml</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config to remote hosts</span><br><span class="line">      template: src&#x3D;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">ansible-playbook temnginx2.yml</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中template算术运算"><a href="#Playbook中template算术运算" class="headerlink" title="Playbook中template算术运算"></a>Playbook中template算术运算</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">算法运算：</span><br><span class="line">示例：</span><br><span class="line">    vim nginx.conf.j2</span><br><span class="line">    worker_processes &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;</span><br><span class="line">    worker_processes &#123;&#123; ansible_processor_vcpus+2 &#125;&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="when-实现条件判断"><a href="#when-实现条件判断" class="headerlink" title="when  实现条件判断"></a>when  实现条件判断</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">条件测试:如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,</span><br><span class="line">通过when语句实现，在task中使用，jinja2的语法格式</span><br><span class="line"></span><br><span class="line">when语句</span><br><span class="line">    在task后添加when子句即可使用条件测试；when语句支持Jinja2表达式语法</span><br><span class="line">示例：</span><br><span class="line">tasks:</span><br><span class="line">  - name: &quot;shutdown RedHat flavored systems&quot;</span><br><span class="line">    command: &#x2F;sbin&#x2F;shutdown -h now</span><br><span class="line">    when: ansible_os_family &#x3D;&#x3D; &quot;RedHat&quot;  当系统属于红帽系列,执行command模块 </span><br><span class="line"> </span><br><span class="line">when语句中还可以使用Jinja2的大多&quot;filter&quot;，</span><br><span class="line">例如要忽略此前某语句的错误并基于其结果(failed或者success)运行后面指定的语句，</span><br><span class="line">可使用类似如下形式：</span><br><span class="line">tasks:</span><br><span class="line">  - command: &#x2F;bin&#x2F;false</span><br><span class="line">    register: result</span><br><span class="line">    ignore_errors: True</span><br><span class="line">  - command: &#x2F;bin&#x2F;something</span><br><span class="line">    when: result|failed</span><br><span class="line">  - command: &#x2F;bin&#x2F;something_else</span><br><span class="line">    when: result|success</span><br><span class="line">  - command: &#x2F;bin&#x2F;still&#x2F;something_else</span><br><span class="line">    when: result|skipped</span><br><span class="line"></span><br><span class="line">此外，when语句中还可以使用facts或playbook中定义的变量</span><br></pre></td></tr></table></figure>
<h3 id="示例：when条件判断"><a href="#示例：when条件判断" class="headerlink" title="示例：when条件判断"></a>示例：when条件判断</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: add group nginx</span><br><span class="line">      tags: user</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: add user nginx</span><br><span class="line">      user: name&#x3D;nginx state&#x3D;present group&#x3D;nginx</span><br><span class="line">    - name: Install Nginx</span><br><span class="line">      yum: name&#x3D;nginx state&#x3D;present</span><br><span class="line">    - name: restart Nginx</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;restarted</span><br><span class="line">      when: ansible_distribution_major_version &#x3D;&#x3D; &quot;6&quot;</span><br></pre></td></tr></table></figure>

<h3 id="示例：when条件判断-1"><a href="#示例：when条件判断-1" class="headerlink" title="示例：when条件判断"></a>示例：when条件判断</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">tasks:</span><br><span class="line">  - name: install conf file to centos7</span><br><span class="line">    template: src&#x3D;nginx.conf.c7.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">    when: ansible_distribution_major_version &#x3D;&#x3D; &quot;7&quot;</span><br><span class="line">  - name: install conf file to centos6</span><br><span class="line">    template: src&#x3D;nginx.conf.c6.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">    when: ansible_distribution_major_version &#x3D;&#x3D; &quot;6&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中when条件判断"><a href="#Playbook中when条件判断" class="headerlink" title="Playbook中when条件判断"></a>Playbook中when条件判断</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: srv120</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name:</span><br><span class="line">      template: src&#x3D;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version &#x3D;&#x3D; &quot;7&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/res/100097/A6150393F3CF41DEAFD7A7002C2F952E" alt="image"></p>
<h3 id="迭代：with-items"><a href="#迭代：with-items" class="headerlink" title="迭代：with_items"></a>迭代：with_items</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">迭代：当有需要重复性执行的任务时，可以使用迭代机制</span><br><span class="line">    &gt; 对迭代项的引用，固定变量名为&quot;item&quot;</span><br><span class="line">    &gt; 要在task中使用with_items给定要迭代的元素列表</span><br><span class="line">    &gt; 列表格式：</span><br><span class="line">         字符串</span><br><span class="line">         字典</span><br></pre></td></tr></table></figure>

<h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">示例： 创建用户</span><br><span class="line">- name: add several users</span><br><span class="line">  user: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present groups&#x3D;wheel   #&#123;&#123; item &#125;&#125; 系统自定义变量</span><br><span class="line">  with_items:       # 定义&#123;&#123; item &#125;&#125; 的值和个数</span><br><span class="line">    - testuser1</span><br><span class="line">    - testuser2</span><br><span class="line"></span><br><span class="line">上面语句的功能等同于下面的语句：</span><br><span class="line">- name: add user testuser1</span><br><span class="line">  user: name&#x3D;testuser1 state&#x3D;present groups&#x3D;wheel</span><br><span class="line">- name: add user testuser2</span><br><span class="line">  user: name&#x3D;testuser2 state&#x3D;present groups&#x3D;wheel</span><br><span class="line">  </span><br><span class="line">with_items中可以使用元素还可为hashes</span><br><span class="line">示例：</span><br><span class="line">- name: add several users</span><br><span class="line">  user: name&#x3D;&#123;&#123; item.name &#125;&#125; state&#x3D;present groups&#x3D;&#123;&#123; item.groups &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; name: &#39;testuser1&#39;, groups: &#39;wheel&#39; &#125;</span><br><span class="line">    - &#123; name: &#39;testuser2&#39;, groups: &#39;root&#39; &#125;</span><br><span class="line"></span><br><span class="line">ansible的循环机制还有更多的高级功能，具体请参见官方文档</span><br><span class="line">http:&#x2F;&#x2F;docs.ansible.com&#x2F;playbooks_loops.html</span><br></pre></td></tr></table></figure>

<h3 id="示例：迭代"><a href="#示例：迭代" class="headerlink" title="示例：迭代"></a>示例：迭代</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">示例：将多个文件进行copy到被控端</span><br><span class="line">---</span><br><span class="line">- hosts: testsrv</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks</span><br><span class="line">  - name: Create rsyncd config</span><br><span class="line">    copy: src&#x3D;&#123;&#123; item &#125;&#125; dest&#x3D;&#x2F;etc&#x2F;&#123;&#123; item &#125;&#125;</span><br><span class="line">    with_items:</span><br><span class="line">  - rsyncd.secrets</span><br><span class="line">  - rsyncd.conf</span><br></pre></td></tr></table></figure>

<h3 id="示例：迭代-1"><a href="#示例：迭代-1" class="headerlink" title="示例：迭代"></a>示例：迭代</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: copy file</span><br><span class="line">      copy: src&#x3D;&#123;&#123; item &#125;&#125; dest&#x3D;&#x2F;tmp&#x2F;&#123;&#123; item &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">    - file1</span><br><span class="line">    - file2</span><br><span class="line">    - file3</span><br><span class="line">- name: yum install httpd</span><br><span class="line">  yum: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present</span><br><span class="line">  with_items:</span><br><span class="line">    - apr</span><br><span class="line">    - apr-util</span><br><span class="line">    - httpd</span><br></pre></td></tr></table></figure>

<h3 id="示例：迭代-2"><a href="#示例：迭代-2" class="headerlink" title="示例：迭代"></a>示例：迭代</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- hosts：websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks</span><br><span class="line">    - name: install some packages</span><br><span class="line">      yum: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present</span><br><span class="line">      with_items:</span><br><span class="line">        - nginx</span><br><span class="line">        - memcached</span><br><span class="line">        - php-fpm</span><br></pre></td></tr></table></figure>

<h3 id="示例：迭代嵌套子变量"><a href="#示例：迭代嵌套子变量" class="headerlink" title="示例：迭代嵌套子变量"></a>示例：迭代嵌套子变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- hosts：websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">    - name: add some groups</span><br><span class="line">      group: name&#x3D;&#123;&#123; item &#125;&#125; state&#x3D;present</span><br><span class="line">      with_items:</span><br><span class="line">        - group1</span><br><span class="line">        - group2</span><br><span class="line">        - group3</span><br><span class="line">    - name: add some users</span><br><span class="line">      user: name&#x3D;&#123;&#123; item.name &#125;&#125; group&#x3D;&#123;&#123; item.group &#125;&#125; state&#x3D;present</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: &#39;user1&#39;, group: &#39;group1&#39; &#125;</span><br><span class="line">        - &#123; name: &#39;user2&#39;, group: &#39;group2&#39; &#125;</span><br><span class="line">        - &#123; name: &#39;user3&#39;, group: &#39;group3&#39; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="with-itmes-嵌套子变量"><a href="#with-itmes-嵌套子变量" class="headerlink" title="with_itmes 嵌套子变量"></a>with_itmes 嵌套子变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">with_itmes 嵌套子变量</span><br><span class="line">示例</span><br><span class="line">---</span><br><span class="line">- hosts: testweb</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: add several users</span><br><span class="line">      user: name&#x3D;&#123;&#123; item.name &#125;&#125; state&#x3D;present groups&#x3D;&#123;&#123; item.groups &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">    - &#123; name: &#39;testuser1&#39; , groups: &#39;wheel&#39;&#125;</span><br><span class="line">    - &#123; name: &#39;testuser2&#39; , groups: &#39;root&#39;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Playbook字典-with-items"><a href="#Playbook字典-with-items" class="headerlink" title="Playbook字典 with_items"></a>Playbook字典 with_items</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- name: 使用ufw模块来管理哪些端口需要开启</span><br><span class="line">  ufw:</span><br><span class="line">  rule: “&#123;&#123; item.rule &#125;&#125;”</span><br><span class="line">  port: “&#123;&#123; item.port &#125;&#125;”</span><br><span class="line">  proto: “&#123;&#123; item.proto &#125;&#125;”</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; rule: &#39;allow&#39;, port: 22, proto: &#39;tcp&#39; &#125;</span><br><span class="line">    - &#123; rule: &#39;allow&#39;, port: 80, proto: &#39;tcp&#39; &#125;</span><br><span class="line">    - &#123; rule: &#39;allow&#39;, port: 123, proto: &#39;udp&#39; &#125;</span><br><span class="line"></span><br><span class="line">- name: 配置网络进出方向的默认规则</span><br><span class="line">  ufw:</span><br><span class="line">  direction: &quot;&#123;&#123; item.direction &#125;&#125;&quot;</span><br><span class="line">  policy: &quot;&#123;&#123; item.policy &#125;&#125;&quot;</span><br><span class="line">  state: enabled</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; direction: outgoing, policy: allow &#125;</span><br><span class="line">    - &#123; direction: incoming, policy: deny &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Playbook中template-for-if-when循环"><a href="#Playbook中template-for-if-when循环" class="headerlink" title="Playbook中template for if  when循环"></a>Playbook中template for if  when循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for vhost in nginx_vhosts %&#125;</span><br><span class="line"></span><br><span class="line">server &#123;    #重复执行server代码</span><br><span class="line">listen &#123;&#123; vhost.listen | default(&#39;80 default_server&#39;) &#125;&#125;;</span><br><span class="line"></span><br><span class="line">&#123;% if vhost.server_name is defined %&#125;</span><br><span class="line">server_name &#123;&#123; vhost.server_name &#125;&#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if vhost.root is defined %&#125;</span><br><span class="line">root &#123;&#123; vhost.root &#125;&#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; temnginx.yml</span><br><span class="line">---</span><br><span class="line">- hosts: testweb</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:      # 调用变量</span><br><span class="line">    nginx_vhosts:</span><br><span class="line">      - listen: 8080  #列表 键值对</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;templates&#x2F;nginx.conf.j2</span><br><span class="line">&#123;% for vhost in nginx_vhosts %&#125;  </span><br><span class="line">server &#123;</span><br><span class="line">  listen &#123;&#123; vhost.listen &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">生成的结果</span><br><span class="line">server &#123;</span><br><span class="line">  listen 8080</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; temnginx.yml</span><br><span class="line">---</span><br><span class="line">- hosts: mageduweb</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    nginx_vhosts:</span><br><span class="line">      - web1</span><br><span class="line">      - web2</span><br><span class="line">      - web3</span><br><span class="line">  tasks:</span><br><span class="line">    - name: template config</span><br><span class="line">      template: src&#x3D;nginx.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; templates&#x2F;nginx.conf.j2</span><br><span class="line">&#123;% for vhost in nginx_vhosts %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen &#123;&#123; vhost &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">生成的结果：</span><br><span class="line">server &#123;</span><br><span class="line">    listen web1</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen web2</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen web3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">roles</span><br><span class="line">    ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。</span><br><span class="line">    roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。</span><br><span class="line">    要使用roles只需要在playbook中使用include指令即可。</span><br><span class="line">    简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，</span><br><span class="line">    并可以便捷地include它们的一种机制。</span><br><span class="line">    角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中</span><br><span class="line"></span><br><span class="line">复杂场景：建议使用roles，代码复用度高</span><br><span class="line">    变更指定主机或主机组</span><br><span class="line">    如命名不规范维护和传承成本大</span><br><span class="line">    某些功能需多个Playbook，通过includes即可实现</span><br></pre></td></tr></table></figure>

<h3 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">角色(roles)：角色集合</span><br><span class="line">roles&#x2F;</span><br><span class="line">    mysql&#x2F;</span><br><span class="line">    httpd&#x2F;</span><br><span class="line">    nginx&#x2F;</span><br><span class="line">    memcached&#x2F;</span><br><span class="line">    </span><br><span class="line">可以互相调用</span><br></pre></td></tr></table></figure>

<h3 id="Ansible-Roles目录编排"><a href="#Ansible-Roles目录编排" class="headerlink" title="Ansible Roles目录编排"></a>Ansible Roles目录编排</h3><p><img src="https://note.youdao.com/yws/res/100101/63539E099AD1483D87CD28CBD473463B" alt="image"> </p>
<h3 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">每个角色，以特定的层级目录结构进行组织</span><br><span class="line">roles目录结构：</span><br><span class="line"></span><br><span class="line">playbook.yml  调用角色</span><br><span class="line">roles&#x2F;</span><br><span class="line">  project&#x2F; (角色名称)</span><br><span class="line">    tasks&#x2F;</span><br><span class="line">    files&#x2F;</span><br><span class="line">    vars&#x2F;</span><br><span class="line">    templates&#x2F;</span><br><span class="line">    handlers&#x2F;</span><br><span class="line">    default&#x2F; 不常用</span><br><span class="line">    meta&#x2F;    不常用</span><br></pre></td></tr></table></figure>

<h3 id="Roles各目录作用"><a href="#Roles各目录作用" class="headerlink" title="Roles各目录作用"></a>Roles各目录作用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;roles&#x2F;project&#x2F; :项目名称,有以下子目录</span><br><span class="line">    files&#x2F; ：存放由copy或script模块等调用的文件</span><br><span class="line">    templates&#x2F;：template模块查找所需要模板文件的目录</span><br><span class="line">    tasks&#x2F;：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；</span><br><span class="line">            其它的文件需要在此文件中通过include进行包含</span><br><span class="line">    handlers&#x2F;：至少应该包含一个名为main.yml的文件；</span><br><span class="line">               其它的文件需要在此文件中通过include进行包含</span><br><span class="line">    vars&#x2F;：定义变量，至少应该包含一个名为main.yml的文件；</span><br><span class="line">           其它的文件需要在此文件中通过include进行包含</span><br><span class="line">    meta&#x2F;：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，</span><br><span class="line">           其它文件需在此文件中通过include进行包含</span><br><span class="line">    default&#x2F;：设定默认变量时使用此目录中的main.yml文件</span><br><span class="line">    </span><br><span class="line">roles&#x2F;appname 目录结构</span><br><span class="line">    tasks目录：至少应该包含一个名为main.yml的文件，其定义了此角色的任务列表；</span><br><span class="line">               此文件可以使用include包含其它的位于此目录中的task文件</span><br><span class="line">    files目录：存放由copy或script等模块调用的文件；</span><br><span class="line">    templates目录：template模块会自动在此目录中寻找Jinja2模板文件</span><br><span class="line">    handlers目录：此目录中应当包含一个main.yml文件，用于定义此角色用到的各handler；</span><br><span class="line">                  在handler中使用include包含的其它的handler文件也应该位于此目录中；</span><br><span class="line">    vars目录：应当包含一个main.yml文件，用于定义此角色用到的变量；</span><br><span class="line">    meta目录：应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系；</span><br><span class="line">              ansible1.3及其以后的版本才支持；</span><br><span class="line">    default目录：为当前角色设定默认变量时使用此目录；应当包含一个main.yml文件</span><br><span class="line"></span><br><span class="line">roles&#x2F;example_role&#x2F;files&#x2F;             所有文件，都将可存放在这里</span><br><span class="line">roles&#x2F;example_role&#x2F;templates&#x2F;         所有模板都存放在这里</span><br><span class="line">roles&#x2F;example_role&#x2F;tasks&#x2F;main.yml：   主函数，包括在其中的所有任务将被执行</span><br><span class="line">roles&#x2F;example_role&#x2F;handlers&#x2F;main.yml：所有包括其中的 handlers 将被执行</span><br><span class="line">roles&#x2F;example_role&#x2F;vars&#x2F;main.yml：    所有包括在其中的变量将在roles中生效</span><br><span class="line">roles&#x2F;example_role&#x2F;meta&#x2F;main.yml：    roles所有依赖将被正常登入</span><br></pre></td></tr></table></figure>

<h3 id="创建role"><a href="#创建role" class="headerlink" title="创建role"></a>创建role</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">创建role的步骤</span><br><span class="line">(1) 创建以roles命名的目录</span><br><span class="line">(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等</span><br><span class="line">(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；</span><br><span class="line">    用不到的目录可以创建为空目录，也可以不创建</span><br><span class="line">(4) 在playbook文件中，调用各角色</span><br></pre></td></tr></table></figure>

<h3 id="实验-创建httpd角色"><a href="#实验-创建httpd角色" class="headerlink" title="实验: 创建httpd角色"></a>实验: 创建httpd角色</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">1&gt; 创建roles目录</span><br><span class="line">   mkdir roles&#x2F;&#123;httpd,mysql,redis&#125;&#x2F;tasks -pv</span><br><span class="line">   mkdir  roles&#x2F;httpd&#x2F;&#123;handlers,files&#125;</span><br><span class="line"></span><br><span class="line">查看目录结构</span><br><span class="line">tree roles&#x2F;</span><br><span class="line">    roles&#x2F;</span><br><span class="line">    ├── httpd</span><br><span class="line">    │   ├── files</span><br><span class="line">    │   ├── handlers</span><br><span class="line">    │   └── tasks</span><br><span class="line">    ├── mysql</span><br><span class="line">    │   └── tasks</span><br><span class="line">    └── redis</span><br><span class="line">        └── tasks</span><br><span class="line"></span><br><span class="line">2&gt; 创建目标文件</span><br><span class="line">   cd roles&#x2F;httpd&#x2F;tasks&#x2F;</span><br><span class="line">   touch install.yml config.yml service.yml</span><br><span class="line"></span><br><span class="line">3&gt; vim install.yml</span><br><span class="line">   - name: install httpd package</span><br><span class="line">     yum: name&#x3D;httpd</span><br><span class="line">     </span><br><span class="line">   vim config.yml</span><br><span class="line">   - name: config file  </span><br><span class="line">     copy: src&#x3D;httpd.conf dest&#x3D;&#x2F;etc&#x2F;httpd&#x2F;conf&#x2F; backup&#x3D;yes </span><br><span class="line">   </span><br><span class="line">   vim service.yml</span><br><span class="line">   - name: start service </span><br><span class="line">     service: name&#x3D;httpd state&#x3D;started enabled&#x3D;yes</span><br><span class="line">     </span><br><span class="line">4&gt; 创建main.yml主控文件,调用以上单独的yml文件,</span><br><span class="line">   main.yml定义了谁先执行谁后执行的顺序</span><br><span class="line">   vim main.yml</span><br><span class="line">   - include: install.yml</span><br><span class="line">   - include: config.yml</span><br><span class="line">   - include: service.yml</span><br><span class="line">   </span><br><span class="line">5&gt; 准备httpd.conf文件,放到httpd单独的文件目录下</span><br><span class="line">   cp &#x2F;app&#x2F;ansible&#x2F;flies&#x2F;httpd.conf ..&#x2F;files&#x2F;</span><br><span class="line">   </span><br><span class="line">6&gt; 创建一个网页</span><br><span class="line">   vim flies&#x2F;index.html</span><br><span class="line">   &lt;h1&gt; welcome to weixiaodong home &lt;\h1&gt;</span><br><span class="line"></span><br><span class="line">7&gt; 创建网页的yml文件</span><br><span class="line">   vim tasks&#x2F;index.yml</span><br><span class="line">   - name: index.html</span><br><span class="line">     copy: src&#x3D;index.html dest&#x3D;&#x2F;var&#x2F;www&#x2F;html </span><br><span class="line"></span><br><span class="line">8&gt; 将网页的yml文件写进mian.yml文件中</span><br><span class="line">   vim mian.yml</span><br><span class="line">   - include: install.yml</span><br><span class="line">   - include: config.yml</span><br><span class="line">   - include: index.yml</span><br><span class="line">   - include: service.yml</span><br><span class="line"></span><br><span class="line">9&gt; 在handlers目录下创建handler文件mian.yml</span><br><span class="line">   vim handlers&#x2F;main.yml</span><br><span class="line">   - name: restart service httpd</span><br><span class="line">     service: name&#x3D;httpd state&#x3D;restarted</span><br><span class="line"></span><br><span class="line">10&gt; 创建文件调用httpd角色</span><br><span class="line">    cd &#x2F;app&#x2F;ansidle&#x2F;roles</span><br><span class="line">    vim role_httpd.yml</span><br><span class="line">    ---</span><br><span class="line">    # httpd role</span><br><span class="line">    - hosts: appsrvs</span><br><span class="line">      remote_user: root </span><br><span class="line"></span><br><span class="line">      roles:       #调用角色</span><br><span class="line">        - role: httpd  </span><br><span class="line">        </span><br><span class="line">11&gt; 查看目录结构</span><br><span class="line">    tree </span><br><span class="line">    .</span><br><span class="line">    httpd</span><br><span class="line">    ├── files</span><br><span class="line">    │   ├── httpd.conf</span><br><span class="line">    │   └── index.html</span><br><span class="line">    ├── handlers</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    └── tasks</span><br><span class="line">        ├── config.yml</span><br><span class="line">        ├── index.yml</span><br><span class="line">        ├── install.yml</span><br><span class="line">        ├── main.yml</span><br><span class="line">        └── service.yml</span><br><span class="line"></span><br><span class="line">12&gt; ansible-playbook role_httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="针对大型项目使用Roles进行编排"><a href="#针对大型项目使用Roles进行编排" class="headerlink" title="针对大型项目使用Roles进行编排"></a>针对大型项目使用Roles进行编排</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">roles目录结构：</span><br><span class="line">playbook.yml</span><br><span class="line">roles&#x2F;</span><br><span class="line">  project&#x2F;</span><br><span class="line">    tasks&#x2F;</span><br><span class="line">    files&#x2F;</span><br><span class="line">    vars&#x2F;</span><br><span class="line">    templates&#x2F;</span><br><span class="line">    handlers&#x2F;</span><br><span class="line">    default&#x2F; # 不经常用</span><br><span class="line">    meta&#x2F;    # 不经常用</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">nginx-role.yml</span><br><span class="line">roles&#x2F;</span><br><span class="line">└── nginx</span><br><span class="line">    ├── files</span><br><span class="line">    │ └── main.yml</span><br><span class="line">    ├── tasks</span><br><span class="line">    │ ├── groupadd.yml</span><br><span class="line">    │ ├── install.yml</span><br><span class="line">    │ ├── main.yml</span><br><span class="line">    │ ├── restart.yml</span><br><span class="line">    │ └── useradd.yml</span><br><span class="line">    └── vars</span><br><span class="line">        └── main.yml</span><br></pre></td></tr></table></figure>
<h3 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">roles的示例如下所示：</span><br><span class="line">site.yml</span><br><span class="line">webservers.yml</span><br><span class="line">dbservers.yml</span><br><span class="line">roles&#x2F;</span><br><span class="line">  common&#x2F;</span><br><span class="line">    files&#x2F;</span><br><span class="line">    templates&#x2F;</span><br><span class="line">    tasks&#x2F;</span><br><span class="line">    handlers&#x2F;</span><br><span class="line">    vars&#x2F;</span><br><span class="line">    meta&#x2F;</span><br><span class="line">  webservers&#x2F;</span><br><span class="line">    files&#x2F;</span><br><span class="line">    templates&#x2F;</span><br><span class="line">    tasks&#x2F;</span><br><span class="line">  handlers&#x2F;</span><br><span class="line">    vars&#x2F;</span><br><span class="line">    meta&#x2F;</span><br></pre></td></tr></table></figure>

<h3 id="实验：-创建一个nginx角色"><a href="#实验：-创建一个nginx角色" class="headerlink" title="实验： 创建一个nginx角色"></a>实验： 创建一个nginx角色</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">建立nginx角色在多台主机上来部署nginx需要安装 创建账号</span><br><span class="line">1&gt; 创建nginx角色目录</span><br><span class="line">     cd &#x2F;app&#x2F;ansible&#x2F;role</span><br><span class="line">     mkdir nginx&#123;tesks,templates,hanslers&#125; -pv</span><br><span class="line"></span><br><span class="line">2&gt; 创建任务目录</span><br><span class="line">     cd tasks&#x2F;</span><br><span class="line">     touch insatll.yml config.yml service.yml file.yml user.yml</span><br><span class="line">   创建main.yml文件定义任务执行顺序</span><br><span class="line">     vim main.yml</span><br><span class="line">     - include: user.yml</span><br><span class="line">     - include: insatll.yml</span><br><span class="line">     - include: config.yml</span><br><span class="line">     - include: file.yml</span><br><span class="line">     - include: service.yml</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">3&gt; 准备配置文件(centos7、8)</span><br><span class="line">   ll &#x2F;app&#x2F;ansible&#x2F;role&#x2F;nginx&#x2F;templates&#x2F;</span><br><span class="line">   nginx7.conf.j2</span><br><span class="line">   nginx8.conf.j2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4&gt; 定义任务</span><br><span class="line">   vim tasks&#x2F;install.yml</span><br><span class="line">   - name: install</span><br><span class="line">     yum: name&#x3D;nginx</span><br><span class="line">     </span><br><span class="line">   vim tasks&#x2F;config.yml</span><br><span class="line">    - name: config file</span><br><span class="line">      template: src&#x3D;nginx7.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version&#x3D;&#x3D;&quot;7&quot;</span><br><span class="line">      notify: restrat</span><br><span class="line">      </span><br><span class="line">    - name: config file</span><br><span class="line">      template: src&#x3D;nginx8.conf.j2 dest&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">      when: ansible_distribution_major_version&#x3D;&#x3D;&quot;8&quot;</span><br><span class="line">      notify: restrat</span><br><span class="line">      </span><br><span class="line">    vim tasks&#x2F;file.yml   跨角色调用file.yum文件,实现文件复用</span><br><span class="line">    - name: index.html</span><br><span class="line">      copy: src&#x3D;roles&#x2F;httpd&#x2F;files&#x2F;index.html dest&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F; </span><br><span class="line">   </span><br><span class="line">    vim tasks&#x2F;service.yml</span><br><span class="line">    - nmae: start service</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;started enabled&#x3D;yes</span><br><span class="line">      </span><br><span class="line">    vim handlers&#x2F;main.yml</span><br><span class="line">    - name: restrat</span><br><span class="line">      service: name&#x3D;nginx state&#x3D;restarted</span><br><span class="line">      </span><br><span class="line">    vim roles&#x2F;role_nginix.yml</span><br><span class="line">    --- </span><br><span class="line">    #test rcle</span><br><span class="line">    - hosts: appsrvs</span><br><span class="line">    </span><br><span class="line">      roles: </span><br><span class="line">        - role: nginx</span><br><span class="line">        </span><br><span class="line">5&gt; 测试安装</span><br><span class="line">   ansible-playbook role_nginx.yml</span><br></pre></td></tr></table></figure>

<h3 id="Roles案例"><a href="#Roles案例" class="headerlink" title="Roles案例"></a>Roles案例</h3><p>Roles目录编排<br><img src="https://note.youdao.com/yws/res/100102/31BB6620C07C4E8DAEC14CB20CF8C573" alt="image"></p>
<p>Playbook中调用<br><img src="https://note.youdao.com/yws/res/100105/B2206BA3F50D46ACBCC941F778A2C845" alt="image"></p>
<h3 id="playbook调用角色"><a href="#playbook调用角色" class="headerlink" title="playbook调用角色"></a>playbook调用角色</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">调用角色方法1：</span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  roles:</span><br><span class="line">    - mysql</span><br><span class="line">    - memcached</span><br><span class="line">    - nginx</span><br><span class="line">sts:</span><br><span class="line">  remote_user:</span><br><span class="line">  roles:</span><br><span class="line">    - mysql</span><br><span class="line">    - &#123; role: nginx, username: nginx &#125;   #不同的角色调用不同的变量  </span><br><span class="line">    键role用于指定角色名称</span><br><span class="line">    后续的k&#x2F;v用于传递变量给角色</span><br><span class="line"></span><br><span class="line">调用角色方法3：还可基于条件测试实现角色调用</span><br><span class="line">roles:</span><br><span class="line">  - &#123; role: nginx, username: nginx, when: ansible_distribution_major_version &#x3D;&#x3D; &#39;7&#39; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过roles传递变量"><a href="#通过roles传递变量" class="headerlink" title="通过roles传递变量"></a>通过roles传递变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">通过roles传递变量</span><br><span class="line">当给一个主机应用角色的时候可以传递变量，然后在角色内使用这些变量</span><br><span class="line">示例：</span><br><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">    - common</span><br><span class="line">    - &#123; role: foo_app_instance, dir: &#39;&#x2F;web&#x2F;htdocs&#x2F;a.com&#39;, port: 8080 &#125;</span><br></pre></td></tr></table></figure>

<h3 id="向roles传递参数"><a href="#向roles传递参数" class="headerlink" title="向roles传递参数"></a>向roles传递参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">而在playbook中，可以这样使用roles：</span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">    - common</span><br><span class="line">    - webservers</span><br><span class="line"></span><br><span class="line">也可以向roles传递参数</span><br><span class="line">示例：</span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">    - common</span><br><span class="line">    - &#123; role: foo_app_instance, dir: &#39;&#x2F;opt&#x2F;a&#39;, port: 5000 &#125;</span><br><span class="line">    - &#123; role: foo_app_instance, dir: &#39;&#x2F;opt&#x2F;b&#39;, port: 5001 &#125;</span><br></pre></td></tr></table></figure>

<h3 id="条件式地使用roles"><a href="#条件式地使用roles" class="headerlink" title="条件式地使用roles"></a>条件式地使用roles</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">甚至也可以条件式地使用roles</span><br><span class="line">示例：</span><br><span class="line">---</span><br><span class="line">- hosts: webservers</span><br><span class="line">  roles:</span><br><span class="line">    - &#123; role: some_role, when: &quot;ansible_os_family &#x3D;&#x3D; &#39;RedHat&#39;&quot; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Roles条件及变量等案例"><a href="#Roles条件及变量等案例" class="headerlink" title="Roles条件及变量等案例"></a>Roles条件及变量等案例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">When条件</span><br><span class="line">    roles:</span><br><span class="line">      - &#123;role: nginx, when: &quot;ansible_distribution_major_version &#x3D;&#x3D; &#39;7&#39; &quot; ,username: nginx &#125;</span><br><span class="line">变量调用</span><br><span class="line">- hosts: zabbix-proxy</span><br><span class="line">  sudo: yes</span><br><span class="line">  roles:</span><br><span class="line">    - &#123; role: geerlingguy.php-mysql &#125;</span><br><span class="line">    - &#123; role: dj-wasabi.zabbix-proxy, zabbix_server_host: 192.168.37.167 &#125;</span><br></pre></td></tr></table></figure>

<h3 id="完整的roles架构"><a href="#完整的roles架构" class="headerlink" title="完整的roles架构"></a>完整的roles架构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; nginx-role.yml 顶层任务调用yml文件</span><br><span class="line">---</span><br><span class="line">- hosts: testweb</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: httpd 可执行多个role</span><br><span class="line"></span><br><span class="line">cat roles&#x2F;nginx&#x2F;tasks&#x2F;main.yml</span><br><span class="line">---</span><br><span class="line">- include: groupadd.yml</span><br><span class="line">- include: useradd.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: restart.yml</span><br><span class="line">- include: filecp.yml</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; roles&#x2F;nginx&#x2F;tasks&#x2F;groupadd.yml</span><br><span class="line">---</span><br><span class="line">- name: add group nginx</span><br><span class="line">  user: name&#x3D;nginx state&#x3D;present</span><br><span class="line"></span><br><span class="line">cat roles&#x2F;nginx&#x2F;tasks&#x2F;filecp.yml</span><br><span class="line">---</span><br><span class="line">- name: file copy</span><br><span class="line">  copy: src&#x3D;tom.conf dest&#x3D;&#x2F;tmp&#x2F;tom.conf</span><br><span class="line"></span><br><span class="line">以下文件格式类似：</span><br><span class="line">useradd.yml,install.yml,restart.yml</span><br><span class="line"></span><br><span class="line">ls roles&#x2F;nginx&#x2F;files&#x2F;</span><br><span class="line">tom.conf</span><br></pre></td></tr></table></figure>

<h3 id="roles-playbook-tags使用"><a href="#roles-playbook-tags使用" class="headerlink" title="roles playbook tags使用"></a>roles playbook tags使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">roles playbook tags使用</span><br><span class="line">    ansible-playbook --tags&#x3D;&quot;nginx,httpd,mysql&quot; nginx-role.yml  对标签进行挑选执行</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; nginx-role.yml</span><br><span class="line">---</span><br><span class="line">- hosts: testweb</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - &#123; role: nginx ,tags: [ &#39;nginx&#39;, &#39;web&#39; ] ,when: ansible_distribution_major_version &#x3D;&#x3D; &quot;6“ &#125;</span><br><span class="line">    - &#123; role: httpd ,tags: [ &#39;httpd&#39;, &#39;web&#39; ] &#125;</span><br><span class="line">    - &#123; role: mysql ,tags: [ &#39;mysql&#39;, &#39;db&#39; ] &#125;</span><br><span class="line">    - &#123; role: marridb ,tags: [ &#39;mysql&#39;, &#39;db&#39; ] &#125;</span><br><span class="line">    - &#123; role: php &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验-创建角色memcached"><a href="#实验-创建角色memcached" class="headerlink" title="实验: 创建角色memcached"></a>实验: 创建角色memcached</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">memcacched 当做缓存用,会在内存中开启一块空间充当缓存</span><br><span class="line">cat &#x2F;etc&#x2F;sysconfig&#x2F;memcached </span><br><span class="line">    PORT&#x3D;&quot;11211&quot;</span><br><span class="line">    USER&#x3D;&quot;memcached&quot;</span><br><span class="line">    MAXCONN&#x3D;&quot;1024&quot;</span><br><span class="line">    CACHESIZE&#x3D;&quot;64&quot;    # 缓存空间默认64M </span><br><span class="line">    OPTIONS&#x3D;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1&gt; 创建对用目录</span><br><span class="line">   cd &#x2F;app&#x2F;ansible</span><br><span class="line">   mkdir roles&#x2F;memcached&#x2F;&#123;tasks,templates&#125; -pv</span><br><span class="line">   </span><br><span class="line">2&gt; 拷贝memcached配置文件模板</span><br><span class="line">   cp &#x2F;etc&#x2F;sysconfig&#x2F;memcached  templates&#x2F;memcached.j2</span><br><span class="line">   vim templates&#x2F;memcached.j2</span><br><span class="line">   CACHESIZE&#x3D;&quot;&#123;&#123;ansible_memtotal_mb&#x2F;&#x2F;4&#125;&#125;&quot;   #物理内存的1&#x2F;4用做缓存</span><br><span class="line">   </span><br><span class="line">3&gt; 创建对应yml文件,并做相应配置</span><br><span class="line">   cd tasks&#x2F;</span><br><span class="line">   touch install.yml config.yml service.yml</span><br><span class="line">   创建main.yml文件定义任务执行顺序</span><br><span class="line">   vim main.yml</span><br><span class="line">   - include: install.yml</span><br><span class="line">   - include: config.yml</span><br><span class="line">   - include: service.yml  </span><br><span class="line">   </span><br><span class="line">   vim install.yml</span><br><span class="line">   - name: install </span><br><span class="line">     yum: name&#x3D;memcached</span><br><span class="line">     </span><br><span class="line">   vim config.yml</span><br><span class="line">   - name: config file</span><br><span class="line">     template: src&#x3D;memcached.j2 dets&#x3D;&#x2F;etc&#x2F;sysconfig&#x2F;memcached</span><br><span class="line"></span><br><span class="line">   vim service.yml</span><br><span class="line">   - name: service</span><br><span class="line">     service: name&#x3D;memcached state&#x3D;started enabled&#x3D;yes</span><br><span class="line"></span><br><span class="line">4&gt; 创建调用角色文件</span><br><span class="line">   cd &#x2F;app&#x2F;ansible&#x2F;roles&#x2F;</span><br><span class="line">   vim role_memcached.yml</span><br><span class="line">    ---</span><br><span class="line">    - hosts: appsrvs</span><br><span class="line">    </span><br><span class="line">      roles: </span><br><span class="line">        - role: memcached</span><br><span class="line"></span><br><span class="line">5&gt; 安装</span><br><span class="line">   ansible-playbook  role_memcached.yml </span><br><span class="line">   memcached端口号11211</span><br></pre></td></tr></table></figure>

<h3 id="其它功能"><a href="#其它功能" class="headerlink" title="其它功能"></a>其它功能</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">委任（指定某一台机器做某一个task）</span><br><span class="line">    delegate_to</span><br><span class="line">    local_action (专指针对ansible命令执行的机器做的变更操作)</span><br><span class="line">交互提示</span><br><span class="line">    prompt</span><br><span class="line">*暂停（java）</span><br><span class="line">    wait_for</span><br><span class="line">Debug</span><br><span class="line">    debug: msg&#x3D;&quot;This always executes.&quot;</span><br><span class="line">Include</span><br><span class="line">Template 多值合并</span><br><span class="line">Template 动态变量配置</span><br></pre></td></tr></table></figure>

<h3 id="Ansible-Roles"><a href="#Ansible-Roles" class="headerlink" title="Ansible Roles"></a>Ansible Roles</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">委任</span><br><span class="line">    delegate_to</span><br><span class="line">交互提示</span><br><span class="line">    prompt</span><br><span class="line">暂停</span><br><span class="line">    wait_for</span><br><span class="line">Debug</span><br><span class="line">    debug: msg&#x3D;&quot;This always executes.&quot;</span><br><span class="line">Include</span><br><span class="line">Template 多值合并</span><br><span class="line">Template 动态变量配置</span><br></pre></td></tr></table></figure>

<h3 id="推荐资料"><a href="#推荐资料" class="headerlink" title="推荐资料"></a>推荐资料</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;galaxy.ansible.com</span><br><span class="line">https:&#x2F;&#x2F;galaxy.ansible.com&#x2F;explore#&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;github.com&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;ansible.com.cn&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ansible&#x2F;ansible</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ansible&#x2F;ansible-examples</span><br></pre></td></tr></table></figure>

<h3 id="实验-实现二进制安装mysql的卸载"><a href="#实验-实现二进制安装mysql的卸载" class="headerlink" title="实验: 实现二进制安装mysql的卸载"></a>实验: 实现二进制安装mysql的卸载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat remove_mysql.yml </span><br><span class="line">---</span><br><span class="line"># install mariadb server </span><br><span class="line">- hosts: appsrvs:!192.168.38.108</span><br><span class="line">  remote_user: root</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: stop service </span><br><span class="line">      shell: &#x2F;etc&#x2F;init.d&#x2F;mysqld stop</span><br><span class="line">    - name: delete user </span><br><span class="line">      user: name&#x3D;mysql state&#x3D;absent remove&#x3D;yes</span><br><span class="line">    - name: delete</span><br><span class="line">      file: path&#x3D;&#123;&#123;item&#125;&#125; state&#x3D;absent</span><br><span class="line">      with_items: </span><br><span class="line">        - &#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">        - &#x2F;usr&#x2F;local&#x2F;mariadb-10.2.27-linux-x86_64</span><br><span class="line">        - &#x2F;etc&#x2F;init.d&#x2F;mysqld</span><br><span class="line">        - &#x2F;etc&#x2F;profile.d&#x2F;mysql.sh</span><br><span class="line">        - &#x2F;etc&#x2F;my.cnf</span><br><span class="line">        - &#x2F;data&#x2F;mysql</span><br><span class="line"></span><br><span class="line">ansible-playbook  remove_mysql.yml</span><br></pre></td></tr></table></figure>






















      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/21/%E6%90%AD%E5%BB%BApxe%E7%BD%91%E7%BB%9C%E6%89%B9%E9%87%8F%E5%AE%89%E8%A3%85%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83/" rel="next" title="搭建pxe网络批量安装系统环境">
                <i class="fa fa-chevron-left"></i> 搭建pxe网络批量安装系统环境
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/01/04/python%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/" rel="prev" title="python基础教程">
                python基础教程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">运维笔记 QQ:1714594511</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#运维自动化之Ansible"><span class="nav-number">1.</span> <span class="nav-text">运维自动化之Ansible</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本章内容"><span class="nav-number">1.0.1.</span> <span class="nav-text">本章内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#企业实际应用场景分析"><span class="nav-number">1.0.2.</span> <span class="nav-text">企业实际应用场景分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动化运维应用场景"><span class="nav-number">1.0.3.</span> <span class="nav-text">自动化运维应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用自动化运维工具"><span class="nav-number">1.0.4.</span> <span class="nav-text">常用自动化运维工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特性"><span class="nav-number">1.0.5.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#推公钥"><span class="nav-number">1.0.6.</span> <span class="nav-text">推公钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">1.0.7.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关文件"><span class="nav-number">1.0.8.</span> <span class="nav-text">相关文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主机清单inventory"><span class="nav-number">1.0.9.</span> <span class="nav-text">主机清单inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible-配置文件"><span class="nav-number">1.0.10.</span> <span class="nav-text">ansible 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible系列命令"><span class="nav-number">1.0.11.</span> <span class="nav-text">ansible系列命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible"><span class="nav-number">1.0.12.</span> <span class="nav-text">ansible</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible的Host-pattern"><span class="nav-number">1.0.13.</span> <span class="nav-text">ansible的Host-pattern</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible命令执行过程"><span class="nav-number">1.0.14.</span> <span class="nav-text">ansible命令执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible使用示例"><span class="nav-number">1.0.15.</span> <span class="nav-text">ansible使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible常用模块"><span class="nav-number">1.0.16.</span> <span class="nav-text">ansible常用模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible系列命令-1"><span class="nav-number">1.0.17.</span> <span class="nav-text">ansible系列命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#playbook"><span class="nav-number">1.0.18.</span> <span class="nav-text">playbook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#playbook图解"><span class="nav-number">1.0.19.</span> <span class="nav-text">playbook图解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML介绍"><span class="nav-number">1.0.20.</span> <span class="nav-text">YAML介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML语法简介"><span class="nav-number">1.0.21.</span> <span class="nav-text">YAML语法简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML语法简介-1"><span class="nav-number">1.0.22.</span> <span class="nav-text">YAML语法简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML语法"><span class="nav-number">1.0.23.</span> <span class="nav-text">YAML语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三种常见的数据交换格式"><span class="nav-number">1.0.24.</span> <span class="nav-text">三种常见的数据交换格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook核心元素"><span class="nav-number">1.0.25.</span> <span class="nav-text">Playbook核心元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#playbook基础组件"><span class="nav-number">1.0.26.</span> <span class="nav-text">playbook基础组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行playbook"><span class="nav-number">1.0.27.</span> <span class="nav-text">运行playbook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook-VS-ShellScripts"><span class="nav-number">1.0.28.</span> <span class="nav-text">Playbook VS ShellScripts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-Playbook-创建用户"><span class="nav-number">1.0.29.</span> <span class="nav-text">示例:Playbook 创建用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook示例-安装httpd服务"><span class="nav-number">1.0.30.</span> <span class="nav-text">Playbook示例  安装httpd服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook示例-安装nginx服务"><span class="nav-number">1.0.31.</span> <span class="nav-text">Playbook示例  安装nginx服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handlers和notify结合使用触发条件"><span class="nav-number">1.0.32.</span> <span class="nav-text">handlers和notify结合使用触发条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中handlers使用"><span class="nav-number">1.0.33.</span> <span class="nav-text">Playbook中handlers使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">1.0.34.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-1"><span class="nav-number">1.0.35.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中tags使用"><span class="nav-number">1.0.36.</span> <span class="nav-text">Playbook中tags使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-2"><span class="nav-number">1.0.37.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中tags使用-1"><span class="nav-number">1.0.38.</span> <span class="nav-text">Playbook中tags使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中变量的使用"><span class="nav-number">1.0.39.</span> <span class="nav-text">Playbook中变量的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible基础元素"><span class="nav-number">1.0.40.</span> <span class="nav-text">Ansible基础元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：使用setup变量"><span class="nav-number">1.0.41.</span> <span class="nav-text">示例：使用setup变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：变量"><span class="nav-number">1.0.42.</span> <span class="nav-text">示例：变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：变量-1"><span class="nav-number">1.0.43.</span> <span class="nav-text">示例：变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量"><span class="nav-number">1.0.44.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：变量-2"><span class="nav-number">1.0.45.</span> <span class="nav-text">示例：变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用变量文件"><span class="nav-number">1.0.46.</span> <span class="nav-text">使用变量文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量-1"><span class="nav-number">1.0.47.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#invertory参数"><span class="nav-number">1.0.48.</span> <span class="nav-text">invertory参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#invertory参数-1"><span class="nav-number">1.0.49.</span> <span class="nav-text">invertory参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板templates"><span class="nav-number">1.0.50.</span> <span class="nav-text">模板templates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2相关"><span class="nav-number">1.0.51.</span> <span class="nav-text">Jinja2相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2-算术运算"><span class="nav-number">1.0.52.</span> <span class="nav-text">Jinja2:算术运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2"><span class="nav-number">1.0.53.</span> <span class="nav-text">Jinja2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template-的使用"><span class="nav-number">1.0.54.</span> <span class="nav-text">template 的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template示例"><span class="nav-number">1.0.55.</span> <span class="nav-text">template示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中template变更替换"><span class="nav-number">1.0.56.</span> <span class="nav-text">Playbook中template变更替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中template算术运算"><span class="nav-number">1.0.57.</span> <span class="nav-text">Playbook中template算术运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#when-实现条件判断"><span class="nav-number">1.0.58.</span> <span class="nav-text">when  实现条件判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：when条件判断"><span class="nav-number">1.0.59.</span> <span class="nav-text">示例：when条件判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：when条件判断-1"><span class="nav-number">1.0.60.</span> <span class="nav-text">示例：when条件判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中when条件判断"><span class="nav-number">1.0.61.</span> <span class="nav-text">Playbook中when条件判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迭代：with-items"><span class="nav-number">1.0.62.</span> <span class="nav-text">迭代：with_items</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-3"><span class="nav-number">1.0.63.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：迭代"><span class="nav-number">1.0.64.</span> <span class="nav-text">示例：迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：迭代-1"><span class="nav-number">1.0.65.</span> <span class="nav-text">示例：迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：迭代-2"><span class="nav-number">1.0.66.</span> <span class="nav-text">示例：迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例：迭代嵌套子变量"><span class="nav-number">1.0.67.</span> <span class="nav-text">示例：迭代嵌套子变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-itmes-嵌套子变量"><span class="nav-number">1.0.68.</span> <span class="nav-text">with_itmes 嵌套子变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook字典-with-items"><span class="nav-number">1.0.69.</span> <span class="nav-text">Playbook字典 with_items</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Playbook中template-for-if-when循环"><span class="nav-number">1.0.70.</span> <span class="nav-text">Playbook中template for if  when循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-4"><span class="nav-number">1.0.71.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-5"><span class="nav-number">1.0.72.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#roles"><span class="nav-number">1.0.73.</span> <span class="nav-text">roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Roles"><span class="nav-number">1.0.74.</span> <span class="nav-text">Roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible-Roles目录编排"><span class="nav-number">1.0.75.</span> <span class="nav-text">Ansible Roles目录编排</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#roles目录结构"><span class="nav-number">1.0.76.</span> <span class="nav-text">roles目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Roles各目录作用"><span class="nav-number">1.0.77.</span> <span class="nav-text">Roles各目录作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建role"><span class="nav-number">1.0.78.</span> <span class="nav-text">创建role</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验-创建httpd角色"><span class="nav-number">1.0.79.</span> <span class="nav-text">实验: 创建httpd角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#针对大型项目使用Roles进行编排"><span class="nav-number">1.0.80.</span> <span class="nav-text">针对大型项目使用Roles进行编排</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例-6"><span class="nav-number">1.0.81.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验：-创建一个nginx角色"><span class="nav-number">1.0.82.</span> <span class="nav-text">实验： 创建一个nginx角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Roles案例"><span class="nav-number">1.0.83.</span> <span class="nav-text">Roles案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#playbook调用角色"><span class="nav-number">1.0.84.</span> <span class="nav-text">playbook调用角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过roles传递变量"><span class="nav-number">1.0.85.</span> <span class="nav-text">通过roles传递变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#向roles传递参数"><span class="nav-number">1.0.86.</span> <span class="nav-text">向roles传递参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#条件式地使用roles"><span class="nav-number">1.0.87.</span> <span class="nav-text">条件式地使用roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Roles条件及变量等案例"><span class="nav-number">1.0.88.</span> <span class="nav-text">Roles条件及变量等案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完整的roles架构"><span class="nav-number">1.0.89.</span> <span class="nav-text">完整的roles架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#roles-playbook-tags使用"><span class="nav-number">1.0.90.</span> <span class="nav-text">roles playbook tags使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验-创建角色memcached"><span class="nav-number">1.0.91.</span> <span class="nav-text">实验: 创建角色memcached</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它功能"><span class="nav-number">1.0.92.</span> <span class="nav-text">其它功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible-Roles"><span class="nav-number">1.0.93.</span> <span class="nav-text">Ansible Roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#推荐资料"><span class="nav-number">1.0.94.</span> <span class="nav-text">推荐资料</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实验-实现二进制安装mysql的卸载"><span class="nav-number">1.0.95.</span> <span class="nav-text">实验: 实现二进制安装mysql的卸载</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">

[一个人知道自己为什么而活，就可以忍受任何一种生活。]
&copy; 
<span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">运维笔记 QQ:1714594511</span>

  
</div>


        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":200,"height":400},"mobile":{"show":true},"log":false});</script></body>
</html>
